# 5. EMMC （外部大容量メディアコントローラ）

## はじめに

EMMCは、Arasan™社が提供するMultiMedia™およびSD™カードの組み込み用インタ
フェースです。以下の規格に準拠しています。

- SD™ホストコントローラ標準規格 バージョン3.0 ドラフト1.0
- SDIO™カード規格 Ver.3.0
- SD™メモリカード規格 ドラフトバージョン3.0
- SD™メモリカード・セキュリティ規格 Ver.1.01
- MMC™規格 バージョン3.31、4.2、4.4

以下の文章では、便宜上、SD™、embedded MultiMedia、SDIO™カードのプレース
ホルダとしてカードを使用しています。

EMMCの詳細な内部構造については、Arasan™のドキュメント SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.pdfを参照してください。

EMMCモジュールは他の機能とピンを共有しているため、GPIOインターフェースで選択する
必要があります。詳しくは、GPIOの項を参照してください。

カードのインタフェースは、クロックマネージャモジュールから供給される独自のクロック
`clk_emmc`を使用します。このクロックの周波数には50MHzから100MHzの間で選択する必要が
あります。独自クロックを使用することで、VideoCoreが低いクロック周波数で動作している
場合でも、カードへの高性能なアクセスを可能にしています。EMMCモジュールには、カードの
クロックを`clk_emmc`から生成するための独自の内部クロックデバイダが含まれています。

さらに、カードからの応答とデータのサンプリングクロックを最大40ステップまで遅延させる
ことができ、1ステップあたり200psから1100psの間で設定可能です。この遅延は、読み取り時の
カード内部の遅延（最大14ns）をキャンセルするためのものです。1ステップあたりの遅延
時間は、温度や電源電圧によって変化します。遅延時間の最大値に制限はありませんので、
必要以上に大きな遅延時間を使用することを勧めます。

EMMCモジュールは，コマンドラインとデータラインのハンドシェイク処理とすべてのCRC処理を
自動的に行います。

コマンドの実行は，ARG1レジスタに必要な引数を設定後，CMDTMレジスタにコマンドと適切な
フラグを書き込むことで開始されます。EMMCモジュールは、CRCチェックサムを計算し、
カードにコマンドを転送し、レスポンスを受信してCRCをチェックします。コマンドが実行
されるか，タイムアウトすると，INTERRUPTレジスタのビット0がセットされます。
INTERRUPTレジスタはセルフクリアされませんので，コマンドの終了を検出するために使用
する前に，ソフトウェア側で1を書き込んでリセットする必要がありますのでご注意ください。

ソフトウェアは、カードによる処理が成功したことを確認するために、カードの応答
ステータスビットをチェックする責任があります。

カードとの間でデータを転送するためには、ホストを設定し、CMDTMを使ってカードに
所定のコマンドを送信した後、DATAレジスタにアクセスします。EMMCモジュールは、カードに
送られたコマンドを解釈しないため、CONTROL0レジスタを使用して、カードの設定と同じように
設定することが重要です。特に、データバスの幅がホストとカードで同じになるように設定する
ことが重要です。カードは、クロックを適切にオフにすることで、データの流れを同期させます。
ハンドシェーク信号`dma_req`は、定速 (paced) データ転送に利用できます。INTERRUPT
レジスタのビット1は、データ転送の終了判定に使用できます。INTERRUPTレジスタはセルフ
クリアされないため，データ転送の終了を検出するために使用する前に，ソフトウェア側で
1を書き込んでリセットする必要があることに注意してください。

EMMCモジュールは、最大ブロックサイズを内部データFIFOのサイズである1kバイトに制限して
います。データ転送のパフォーマンスを最大化するためには、複数のブロックによるデータ
転送を使用する必要があります。この場合、EMMCモジュールは2つのFIFOをピンポンモードで
使用します。つまり、1つのFIFOがカードとの間のデータ転送に使用され、もう1つのFIFOが
AXIバスを介してDMAによって同時にアクセスされます。EMMCモジュールがシングルブロック
転送用に構成されている場合、1つのFIFOのみが使用されるため、カードとの間でデータを
転送している間はDMAアクセスができず、デッドタイムが長くなります。

## レジスタ

EMMCモジュールのレジスタは、アラザンのドキュメントとは異なり、32ビットの
レジスタとしてのみアクセス可能です。

EMMCレジスタのベースアドレスは`0x7E300000`（物理アドレスは0x3F300000）です。

### EMMCアドレスマップ

| オフセット | レジスタ名 | 説明 | サイズ |
|:-----------|:-----------|:-----|-------:|
| 0x0  | ARG2 | ACMD23引数 | 32 |
| 0x4  | BLKSIZECNT | ブロックサイズと数 | 32 |
| 0x8  | ARG1 | 引数 | 32 |
| 0xc  | CMDTM | コマンド・転送モード | 32 |
| 0x10 | RESP0 | レスポンスビット[31:0] | 32 |
| 0x14 | RESP1 | レスポンスビット[63:32] | 32 |
| 0x18 | RESP2 | レスポンスビット[95:64] | 32 |
| 0x1c | RESP3 | レスポンスビット[127:96] | 32 |
| 0x20 | DATA | データ | 32 |
| 0x24 | STATUS | ステータス | 32 |
| 0x28 | CONTROL0 | ホスト構成ビット | 32 |
| 0x2c | CONTROL1 | ホスト構成ビット | 32 |
| 0x30 | INTERRUPT | 割り込みフラグ | 32 |
| 0x34 | IRPT_MASK | 割り込みフラグ有効化 | 32 |
| 0x38 | IRPT_EN | 割り込み生成有効化 | 32 |
| 0x3c | CONTROL2 | ホスト構成ビット | 32 |
| 0x50 | FORCE_IRPT | 割り込みイベントを強制 | 32 |
| 0x70 | BOOT_TIMEOUT | ブートモードのタイムアウト | 32 |
| 0x74 | DBG_SEL | デバッグバス構成 | 32 |
| 0x80 | EXRDFIFO_CFG | 拡張FIFO構成 | 32 |
| 0x84 | EXRDFIFO_EN |  拡張FIFO有効化 | 32 |
| 0x88 | TUNE_STEP | カードクロック調整ステップあたりの遅延 | 32 |
| 0x8c | TUNE_STEPS_STD | SDR用のカードクロック調整ステップ | 32 |
| 0x90 | TUNE_STEPS_DDR | DDR用のカードクロック調整ステップ | 32 |
| 0xf0 | SPI_INT_SPT SPI | 割り込みサポート | 32 |
| 0xfc | SLOTISR_VER Slot | 割り込みステータスとバージョン | 32 |


## CMDTMレジスタ

### 概要

このレジスタは、カードにコマンドを発行するために使用されます。コマンドの他に、
どのようなカードレスポンスやデータ転送のタイプを期待するかをEMMCモジュールに
通知するフラグも含まれています。フラグが正しくないと、おかしな動作になります。

データ転送には、1つのデータブロックを転送するモードと、同じサイズの複数の
ブロックを転送するモードがあります。SDカードはこの2つのモードを区別するために
2つの異なるコマンドセットを使用しますが、ホストはTM_MULTI_BLOCKを使用して
追加の設定をする必要があります。カードに送信するコマンドにこのビットを正しく
設定することが重要です。すなわち、CMD18とCMD25には1を、CMD17とCMD24には0を
設定します。マルチブロック転送を行うと、より良いパフォーマンスが得られます。

BLKSIZECNTレジスタは、転送されるブロックのサイズと数を設定するために使用されます。
このレジスタのTM_BLKCNT_ENビットが設定されている場合、BLKSIZECNTレジスタで設定
された数のデータブロックが転送された後、転送が自動的に停止します。

TM_AUTO_CMD_ENビットを使用すると、BLKSIZECNTレジスタのBLKCNTビットが0になった
時点で、データ転送が終了したことを知らせるコマンドを、ホストがカードに自動的に
送信することができます。
