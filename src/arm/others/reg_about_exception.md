# システムレジスタ

## ESR_EL1: Exception Syndrome Register (EL1)

EL1に移行する例外の原因情報を保持する

## ELR_El1: Exectpion Link Register (EL1)

EL1に移行する例外が発生した際の復帰アドレスを保持する

## FAR_EL1: Fault Address Regsiter (EL1)

同期命令やデータアボート、PCアライメントフォルト、ウォッチドック例外
など、EL1に移行するすべての原因となった仮想アドレス

## SPSR_EL1: Saved Program Status Register (EL1)

EL1に移行する例外が発生した際に保存されたプロセス状態を保持する

# ESRのECコードの説明

| EC | 意味 | 定数 |
|:---|:-----|:-----|
| 0x00 | 理由不明 | EC_UNKNOWN |
| 0x15 | AAch64でのSVC命令例外 | EC_SVC64 |
| 0x20 | 下位例外レベルでの命令アボート | EC_IABORT |
| 0x21 | 同じ例外レベルでの命令アボート | EC_IABORT2 |
| 0x24 | 下位例外レベルでのデータアボート | EC_DABORT |
| 0x25 | 同じ例外レベルでのデータアボート | EC_DABORT2 |
| 0x3C | AArch64でのBRK命令例外 | EC_BRK |

# 各ECコードの説明とその他のフィールドの解説

## 0x00: EC_UNKNOWN

このECコードを使用して例外が報告されると、IL フィールドが1に設定される。

このECコードは、他のEC値でカバーされないすべての例外に使用される。これには、
次のような状況で発生する例外が含まれる。

- 割り当てられた命令がない、または現在の例外レベルとセキュリティ状態で
  アクセスできない命令ビットパターンを実行しようとした（以下を含む）。
    - 読み出し用に割り当てられていない、または現在のExceptionレベルと
      Securityステートでは読み出しが許可されていないシステムレジスタパターンを
      使用した読み出しアクセス。
    - 書き込み用に割り当てられていない、または現在の例外レベルとセキュリティ
      状態では書き込みが許可されていないシステムレジスタパターンを使用した
      書き込みアクセス。
    - 未割り当ての命令エンコーディング。
    - 実装されていない命令やシステムレジスタの命令エンコーディング。
- デバッグ状態において、アクセス不可能な命令ビットパターンを実行しようとした。
- 非デバッグ状態において、非デバッグ状態においてアクセスできない命令ビット
  パターンを実行しようとした。
- AArch32状態において、ショートベクタ浮動小数点演算命令を実行しようとした。
- Advanced SIMDおよび浮動小数点機能を含まない実装において、Advanced SIMD
  または浮動小数点機能が存在すればアクセスが許可される状況下で、その機能への
  アクセスが試みられた。これには、Advanced SIMDまたは浮動小数点命令の実行の
  試み、および Advanced SIMDおよび浮動小数点システムレジスタへのアクセスの
  試みが含まれる。
- SCTLR_EL1.{ITD、SED、CP15BEN}制御ビットの1つの値が原因で発生した例外。
- 以下を実行しようとした。
    - HCR_EL2.HCDまたはSCR_EL3.HCEによって無効化されている場合のHVC命令の実行。
    - SCR_EL3.SMDで無効にされている場合のSMC命令。
    - EDSCR.HDEによって無効化されている場合のHLT命令。
- SPSel.SPの値が0のときに、MSRまたはMRS命令でSP_EL0にアクセスしようとした。
- HCR_EL2.E2H == 0のとき、_EL12レジスタ名を使用してMSRまたはMRS命令を実行しようとした。
- デバッグ状態において、以下の命令を実行しようとした。
    - HCR_EL2.TGEの値が1であり、EL2が無効であるか、または現在のセキュリティ
      状態でインプリメントされていないときのDCPS1命令の実行。
    - EL2が無効であるか、または現在のセキュリティ・ステートにインプリメント
      されていない場合のEL1またはEL0からのDCPS2命令。
    - EDSCR.SDDの値が1であるとき、またはEL3がインプリメントされていないときの
      DCPS3インストラクション。
- EL3がAArch64を使用している場合、Secure EL1からR13_monを使用したSRS命令を
  実行しようとした。「AArch32を使用したSecure EL1からSecureモニタ機能のEL3
  へのトラップ」を参照のこと。
- EDSCR.SDDの値が1であるデバッグ状態において、EL3へのトラップが設定された命令を
  EL2、EL1、またはEL0で実行しようとした。
- AArch32状態において、SPSR_mon、SP_mon、またはLR_monへのMRS（バンクドレジスタ）
  またはMSR（バンクドレジスタ）命令の実行が試みられた。
- HCR_EL2.TGEの値が1であるためにEL2に送られた例外は、もしHCR_EL2.TGEの値が0で
  あれば、ESR_ELx.EC値0b000111で報告される。

## 0x15: EC_SVC64

- IMM16 [15:0]は発行された命令のimm16値

## 0x20: EC_IABORT, 0x21: EC_IABORT2

- 命令アクセスにより発生するMMUフォルト、および同期パリティまたはECCエラーを含む
  同期外部アボートに使用される。デバッグ関連の例外には使用されない。
- SET [12:11]: 同期エラータイプ。IFSCが`0b010000`の場合は命令アボート例外後のPEエラー状態を示す
  - `0b00`: リカバリ可能(UER), `0b10`: 抑制不能(UC), `0b10` リスタート可能(UEO)
- FnV [10]: 翻訳表ウォークでの同期外部アボート以外の同期外部アボートの場合、FARは無効
  - `0b0`: FARは有効
- EA [9]: 外部アボートタイプ。
- S1PTW [7]: ステージ2のフォルトの場合、によるステージ2のフォルトステージ1の翻訳表ウォークでのアクセス
  - `0b1`:  ステージ2のフォルト
- IFSC [5:0]: 命令ファルト状態コード
  - `0x01-03`: アドレスサイズフォルト(レベル 1-3)
  - `0x04-07`: 翻訳フォルト(レベル 0-3)
  - `0x08-0b`: アクセスフラグフォル(レベル 0-3)
  - `0x0c-0f`: パーミションフォルト(レベル 0-3)
  - その他は省略


## 0x24: EC_DABORT, 0x25: EC_DABORT2

- データアクセスにより発生するMMUフォルト、スタックポインタミスアライメント以外の
  アライメント障害、同期パリティまたはECCエラーを含む同期外部アボートに対して
  使用される。デバッグ関連の例外には使用されない。
- ISV [24]: ISS[23:14]が有効か否かを示す
  - `0b1`: 有効なinstruction syndrome
- SAS [23:22]: フォルト操作で試みられたアクセスのサイズ
  - `0b00`: バイト, `0b01`: ハーフワード, `0b10`: ワード, `0b11`: ダブルワード
- SSE [21]: データアイテムが符号拡張される必要があるかを示す
  - `0b1`: 符号拡張が必要
- SRT [20:16]: ファルト命令のオペランドのレジスタ番号
- SF [15]: 命令がアクセスしたレジスタの幅
  - @0b0`: 32ビットアクセス、`0b1`: 64ビットアクセス
- AR [14]: `0b1`: 命令はacquire/releaseセマンティクス
- VNCR [13]: 省略
- SET[12:11]: 省略
- FnV [10]: 翻訳表ウォーク上での同期例外以外の同期例外でFARが有効かを示す
  - `0b0`: 有効
- EA [9]: 外部アボートタイプ
- CM [8]: データアボートがキャッシュ維持由来かアドレス翻訳操作によるかを示す
  - `0b1`: いずれかによる
- S1PTW [7]: ステージ1の翻訳表ウォークのアクセス時のステージ2フォルトであるか
  - `0b1`: そうである
- WnR [6]: アボートがRead時かWrite時か
  - `0b0`: Read時, `0b1`: Write時
- DFSC [5:0]: データフォルト状態コード
  - `0-3`: アドレスサイズフォルト(レベル 1-3)
  - `4-7`: 翻訳フォルト(レベル 0-3)
  - `8-11`: アクセスフラグフォル(レベル 0-3)
  - `12-15`: パーミションフォルト(レベル 0-3)
  - `021`: アライメントフォルト
  - その他は省略

## 0x3C: EC_BRK

^ Comment [15:0]
