# 第11章 OTP（ワンタイムプログラマブル）メモリ

このデバイスは1KバイトのOTP (One Time Programmable)メモリーを内蔵しており、
様々な設定データを保存することができ、EEPROM の代替となることで部品コストを
削減することができます。OTPプログラミングがUSB経由でサポートされており、エンド
ユーザのカスタマイズを容易にしています。マイクロチップ社はデバイスのOTPメモリを
設定する包括的なソフトウェアプログラミングツールであるPro-Touchを提供して
います。すべてのOTPコンフィギュレーションはPro-Touchプログラミングツールで
実行できます。Pro-Touchプログラミングツールの詳細については[www.microchip.com](www.microchip.com)を参照してください。

OTPは外部EEPROMと共存することもできます。詳細については、104ページの「10.1 EEPROMとOTPの関係」を参照してください。

## 11.1 OTPフォーマット

OTPフォーマットはEEPROM用に規定されているフォーマットに基づいています。
詳細については104ページの「10.4 EEPROMフォーマット」を参照してください。

EEPROMと同様に、OTPがプログラムされているか否かを定義するためには署名が必要
です。バイト0に`0xF3`または`0xF7`が見つかった場合、そのOTPはプログラムされると
判断されます。

署名`0xF3`はデバイスがOTPのバイトオフセット1からの値（Mac Addressとそれ以降は
EEPROM Contentsに従う）を使用して構成されていることを示します。`0xF7`は
デバイスがOTPのバイトオフセット0x101から値（（Mac Addressとそれ以降はEEPROM
Contentsに従う）をロードして構成されることを示します。

**アプリケーションノート** デュアルシグネチャはOTPを2回プログラムする
メカニズムを可能にします。これは、不注意で誤ったプログラミングをするとデバイスが
機能しなくなるような、デバイスの初回起動時に有用であることが証明される
かもしれません。この方式では0xF3オフセットを使用する場合、OTPの最初の255
バイトだけがプログラムされます。OTPが誤って設定された場合、バイト0の署名を
0xF3から0xF7に変更することにより、バイト0x101から新しい内容を書き込むことで
デバイスを「保存」することができます。
**アプリケーションノート** この動作モードが必要な場合、ソフトウェアは
オフセットが256バイトのデュアル・ーティショニングをサポートするように適切に
構成されていることを確認する必要があります。0xF7を使用する場合でも
オフセットは0x0からとなるからです。

EEPROMと同様にバイト0に有効な署名が存在しない場合、OTPはプログラムされないと
みなされ、デバイスは設定にそれを使用しません。

## 11.2 OTP割り込み

OTP モジュールの割り込みは、インターラプトエンドポイントとインターラプト
ステータスレジスタ（INT_STS）にマッピングされます。

OTPプログラム動作はかなりの時間を要するためポストされます。一般的な目安は
5ms/bitです。プログラム動作の完了はOTP Write Done割り込み（OTP_WR_DONE_INT）に
より通知されます。

## 11.3 OTPシステムリセット

ある種のシステムリセットイベントは「12.0 リセット」で詳述するようにOTPの内容を
再ロードさせます。リセットイベントの後、OTPはまず電源が投入され、その内容が
自動的にデバイスのディスクリプタRAMとさまざまな構成CSRにロードされます。
詳細については「12.0　リセット」を参照してください。
