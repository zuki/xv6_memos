# wait4から戻る際にエラーになる件

当初は次節のようにmake後、ユーザプログラムが実行するまで違うエラーとなったが、
wait4()後にtrapretすると直ちに処理未定義例外が起こるのが本質的な問題

```
# /bin/myls
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af4f000
cml: parent[6] pgdir=0xffff00003af93000, pa=0x3af4f000
cml: child [7] pgdir=0xffff00003af10000, pa=0x3af4f000
fork: old=6, new=7
cmp[7]: addr=0xfffffffff000, pa=0x3aeea000
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
sys_wait4[6]: pid: -1, wstatus: 0xfffffffffb1c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3af4f000
- - wait4: current=6, current->pgdir=0xffff00003af93000, pid=-1
execve: proc[7] '/bin/myls' start, argc=1, envc=1
setup_arg call: addr=0xfffffffe0000, length=0x20000
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af09000
mmaped: pgdir=0xffff00003af10000, addr=0xfffffffff000, pa=0x3af09000
cmp[7]: addr=0xfffffffff000, pa=0x3af37000
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sys_exit: proc[7], status=0
copyout: pgdir=ffff00003af93000, va=0xfffffffffb1c, src=0xffff00000011a734, len=0x4
- uva_to_ka: pgdir=0xffff00003af93000, va=0xfffffffff000, ka=0x3af4f000
- - return 7, status=0
- wait4 return 7, status=0
unexpected interrupt 0 at cpu 0

Synchronous: Unknown:
  ESR_EL1 0x2000000 ELR_EL1 0x419fbc
 SPSR_EL1 0x40000000 FAR_EL1 0x40a640
```

## make後の実行回数により結果が異なる

### 1回め

```
# /bin/myls
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af4f000
cml: parent[6] pgdir=0xffff00003af93000, pa=0x3af4f000
cml: child [7] pgdir=0xffff00003af10000, pa=0x3af4f000
fork: old=6, new=7
cmp[7]: addr=0xfffffffff000, pa=0x3aeea000
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
sys_wait4[6]: pid: -1, wstatus: 0xfffffffffb1c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3af4f000
- - wait4: current=6, current->pgdir=0xffff00003af93000, pid=-1
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
sys_wait4[7]: pid: -1, wstatus: 0xfffffffffb1c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3aeea000
- - wait4: current=7, current->pgdir=0xffff00003af10000, pid=-1
- wait4 return -10, status=0
- return=-10
```

### 2回め

```
# /bin/myls
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af4f000
cml: parent[6] pgdir=0xffff00003af93000, pa=0x3af4f000
cml: child [7] pgdir=0xffff00003af10000, pa=0x3af4f000
fork: old=6, new=7
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
sys_wait4[6]: pid: -1, wstatus: 0xfffffffffb1c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3af4f000
- - wait4: current=6, current->pgdir=0xffff00003af93000, pid=-1
cmp[7]: addr=0xfffffffff000, pa=0x3aeea000
unexpected interrupt 0 at cpu 0

======= PROC[7]: /bin/dash TRAP FRAME DUMP =========
sp:    0x0000fffffffffb20  tpidr: 0x00000000004342f0
spsr:  0x0000000000000000  esr:   0x0000000002000000
elr:   0x0000fffffffffb20  x0:    0x0000000000000000
x1:    0x0000000000000000  x2:    0x0000000000000000
x3:    0x0000000000000008  x4:    0x0000000000436100
x5:    0x0000000000433704  x6:    0x00000000000003b0
x7:    0x0000000000000027  x8:    0x00000000000000dc
x9:    0x0000000000000000  x10:   0x0000000000000000
x11:   0x0000fffffffffcb0  x12:   0x0000000000001030
x13:   0x3d6e702a203a6461  x14:   0x0000000000000001
x15:   0x0000000000000000  x16:   0x000000000041eec0
x17:   0x0000000000000000  x18:   0x0000000000000000
x19:   0x0000000000432000  x20:   0x0000000000434b80
x21:   0x0000000000000000  x22:   0x0000000000432000
x23:   0x0000000000000001  x24:   0x0000000000434b50
x25:   0x0000fffffffffd68  x26:   0x0000000000000000
x27:   0x0000000000000001  x28:   0x0000000000000000
x29:   0x0000fffffffffb20  x30:   0x0000fffffffffb20
===================== DUMP END =====================

==== stack proc[7] =========
fffffffffb20: 0000fffffffffc90 00000000004044d4 000000000042a095 0000000000434b80
fffffffffb40: 0000000000000000 0000000000405534 0000fffffffffc90 0000000000436100
fffffffffb60: 0000000000434b50 0000000000434b98 000000000042a095 ffffffff00432000
fffffffffb80: 0000fffffffffd68 0000000000000000 0000fffffffffd68 0000000000000000
fffffffffba0: 0000fffffffffb10 0000000000413f08 0000000000432000 0000fffffffffb10
fffffffffbc0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffbe0: 0000000000000000 0000000000000000 0000000000000000 000000000042a095
fffffffffc00: 000000000040d514 0000000000000000 0000fffffffffc30 000000000040973c
fffffffffc20: 0000000000433000 000000000040976c 0000fffffffffc90 00000000004043a8
fffffffffc40: 0000000000000000 0000000000434b80 0000000000000018 00114b8f3798ec48
fffffffffc60: 0000fffffffffc90 0000000000404660 000000000042a095 0000000000434b80
fffffffffc80: 0000000000000000 00114b8f3798ec48 0000fffffffffd90 0000000000402f64
fffffffffca0: 0000000000414758 0000000000432000 0000000000000002 0000000000000000
fffffffffcc0: 0000fffffffffdd0 0000000000432000 0000000000000000 0000000000000000
fffffffffce0: 0000000000000000 0000000000000000 0000000000432000 0000000000433000
fffffffffd00: 0000fffffffffd78 ffffffff00000000 0000000000000000 0000000000434b70
fffffffffd20: 0000000000434950 0000000000000000 0000000000000000 0000000000434b98
fffffffffd40: 0000000000434b90 0000000000000000 0000000000434b50 0000000000434b80
fffffffffd60: 0000000000434b80 0000000000000000 0000fffffffffd68 0000000000000000
fffffffffd80: 00000000ffffffff 00114b8f3798ec48 0000fffffffffdf0 0000000000400454
fffffffffda0: 0000000000432000 0000fffffffffe60 0000000000000000 000000000040d7f0
fffffffffdc0: 0000000000429658 00000000004003bc 0000000000434b18 0000000000434b70
fffffffffde0: 00000000000001a8 00114b8f3798ec48 0000000000000000 0000000000419b58
fffffffffe00: 0000000000000001 0000fffffffffeb8 0000000000400150 0000fffffffffec8
fffffffffe20: 0000000000402000 0000000000000000 0000000100000000 0000fffffffffeb8
fffffffffe40: 0000000400000000 0000000000434b18 0000000000434b20 00000000000001f8
fffffffffe60: 0000000000434b18 0000000000434b20 00000000000001f8 00114b8f3798ec48
fffffffffe80: 0000000000000000 0000000000400988 0000000000402178 0000000000403000
fffffffffea0: 0000000000000000 0000000000000000 0000000000000001 0000ffffffffffe9
fffffffffec0: 0000000000000000 0000000000000000 0000000000000010 0000000000000887
fffffffffee0: 0000000000000006 0000000000001000 0000000000000011 0000000000000064
ffffffffff00: 0000000000000003 0000000000400040 0000000000000004 0000000000000038
ffffffffff20: 0000000000000005 0000000000000004 0000000000000007 0000000000000000
ffffffffff40: 0000000000000008 0000000000000000 0000000000000009 00000000004004a0
ffffffffff60: 000000000000000b 0000000000000000 000000000000000c 0000000000000000
ffffffffff80: 000000000000000d 0000000000000000 000000000000000e 0000000000000000
ffffffffffa0: 0000000000000017 0000000000000000 0000000000000033 0000000000001207
ffffffffffc0: 000000000000000f 0000ffffffffffe1 0000000000000000 0000000000000000
ffffffffffe0: 3436686372616100 622f006873616400 00687361642f6e69 0000000000000000

==== stack proc[7] =========

Synchronous: Unknown:
  ESR_EL1 0x2000000 ELR_EL1 0xfffffffffb20
 SPSR_EL1 0x0 FAR_EL1 0xfffffffffb00
	irq_error: irq of type 8 unimplemented.
```

### 3回目

```
# /bin/myls
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af4f000
cml: parent[6] pgdir=0xffff00003af93000, pa=0x3af4f000
cml: child [7] pgdir=0xffff00003af10000, pa=0x3af4f000
fork: old=6, new=7
cmp[7]: addr=0xfffffffff000, pa=0x3aeea000
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
sys_wait4[6]: pid: -1, wstatus: 0xfffffffffb1c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3af4f000
- - wait4: current=6, current->pgdir=0xffff00003af93000, pid=-1
execve: proc[7] '/bin/myls' start, argc=1, envc=1
setup_arg call: addr=0xfffffffe0000, length=0x20000
- map_region: pgdir=0xffff00003af10000, va=0xfffffffff000, pte=0xffff00003af0aff8, pa=0x3af09000
mmaped: pgdir=0xffff00003af10000, addr=0xfffffffff000, pa=0x3af09000
cmp[7]: addr=0xfffffffff000, pa=0x3af37000
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sys_exit: proc[7], status=0
copyout: pgdir=ffff00003af93000, va=0xfffffffffb1c, src=0xffff00000011a734, len=0x4
- uva_to_ka: pgdir=0xffff00003af93000, va=0xfffffffff000, ka=0x3af4f000
- - return 7, status=0
- wait4 return 7, status=0
unexpected interrupt 0 at cpu 0

======= PROC[6]: /bin/dash TRAP FRAME DUMP =========
sp:    0x0000fffffffffa70  tpidr: 0x00000000004342f0
spsr:  0x0000000040000000  esr:   0x0000000002000000
elr:   0x0000000000419fbc  x0:    0x0000000000000007
x1:    0x0000fffffffffb1c  x2:    0x0000000000000002
x3:    0x0000000000000000  x4:    0x000000000042b43e
x5:    0x0000000000433d8c  x6:    0x000000000042b43e
x7:    0x000000007fffffff  x8:    0x0000000000000104
x9:    0x0000000000000000  x10:   0x0000000000000030
x11:   0x0000000000000000  x12:   0x696177206c6c6163
x13:   0x3d646970203a3474  x14:   0x0000000000000000
x15:   0x00000000004295e0  x16:   0x00000000004292b8
x17:   0x0000000000000022  x18:   0x0000fffffffffa90
x19:   0x0000fffffffffb1c  x20:   0x00000000ffffffff
x21:   0x0000000000000000  x22:   0x0000000000000002
x23:   0x0000000000000001  x24:   0x0000000000000002
x25:   0x0000000000419bfc  x26:   0x0000fffffffffb1c
x27:   0x0000fffffffffba0  x28:   0x0000000000000001
x29:   0x0000fffffffffaa0  x30:   0x0000000000419fa4
===================== DUMP END =====================

==== stack proc[6] =========
fffffffffa70: 0000000000432000 0000fffffffffb20 0000000000000001 0000000000419f60
fffffffffa90: 000000000040b718 0000000000000000 0000fffffffffc60 000000000040c8dc
fffffffffab0: 0000000000436100 0000000000432000 0000000000000001 0000000000432000
fffffffffad0: 0000000000000001 0000000000434b50 0000fffffffffd68 0000000000000000
fffffffffaf0: 0000000000000001 0000000000000000 000000000040d584 0000000000436100
fffffffffb10: 0000fffffffffb20 000000000040c820 0000fffffffffc90 00000000004044d4
fffffffffb30: 000000000042a095 0000000000434b80 0000000000000000 0000000000405534
fffffffffb50: 0000fffffffffc90 0000000000436100 0000000000434b50 0000000000434b98
fffffffffb70: 000000000042a095 ffffffff00432000 0000fffffffffd68 0000000000000000
fffffffffb90: 0000fffffffffd68 0000000000000000 0000fffffffffb10 0000000000413f08
fffffffffbb0: 0000000000432000 0000fffffffffb10 0000000000000000 0000000000000000
fffffffffbd0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffbf0: 0000000000000000 000000000042a095 000000000040d514 0000000000000000
fffffffffc10: 0000fffffffffc30 000000000040973c 0000000000433000 000000000040976c
fffffffffc30: 0000fffffffffc90 00000000004043a8 0000000000000000 0000000000434b80
fffffffffc50: 0000000000000018 00114b8f3798ec48 0000fffffffffc90 0000000000404660
fffffffffc70: 000000000042a095 0000000000434b80 0000000000000000 00114b8f3798ec48
fffffffffc90: 0000fffffffffd90 0000000000402f64 0000000000414758 0000000000432000
fffffffffcb0: 0000000000000002 0000000000000000 0000fffffffffdd0 0000000000432000
fffffffffcd0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffcf0: 0000000000432000 0000000000433000 0000fffffffffd78 ffffffff00000000
fffffffffd10: 0000000000000000 0000000000434b70 0000000000434950 0000000000000000
fffffffffd30: 0000000000000000 0000000000434b98 0000000000434b90 0000000000000000
fffffffffd50: 0000000000434b50 0000000000434b80 0000000000434b80 0000000000000000
fffffffffd70: 0000fffffffffd68 0000000000000000 00000000ffffffff 00114b8f3798ec48
fffffffffd90: 0000fffffffffdf0 0000000000400454 0000000000432000 0000fffffffffe60
fffffffffdb0: 0000000000000000 000000000040d7f0 0000000000429658 00000000004003bc
fffffffffdd0: 0000000000434b18 0000000000434b70 00000000000001a8 00114b8f3798ec48
fffffffffdf0: 0000000000000000 0000000000419b58 0000000000000001 0000fffffffffeb8
fffffffffe10: 0000000000400150 0000fffffffffec8 0000000000402000 0000000000000000
fffffffffe30: 0000000100000000 0000fffffffffeb8 0000000400000000 0000000000434b18
fffffffffe50: 0000000000434b20 00000000000001f8 0000000000434b18 0000000000434b20
fffffffffe70: 00000000000001f8 00114b8f3798ec48 0000000000000000 0000000000400988
fffffffffe90: 0000000000402178 0000000000403000 0000000000000000 0000000000000000
fffffffffeb0: 0000000000000001 0000ffffffffffe9 0000000000000000 0000000000000000
fffffffffed0: 0000000000000010 0000000000000887 0000000000000006 0000000000001000
fffffffffef0: 0000000000000011 0000000000000064 0000000000000003 0000000000400040
ffffffffff10: 0000000000000004 0000000000000038 0000000000000005 0000000000000004
ffffffffff30: 0000000000000007 0000000000000000 0000000000000008 0000000000000000
ffffffffff50: 0000000000000009 00000000004004a0 000000000000000b 0000000000000000
ffffffffff70: 000000000000000c 0000000000000000 000000000000000d 0000000000000000
ffffffffff90: 000000000000000e 0000000000000000 0000000000000017 0000000000000000
ffffffffffb0: 0000000000000033 0000000000001207 000000000000000f 0000ffffffffffe1
ffffffffffd0: 0000000000000000 0000000000000000 3436686372616100 622f006873616400
fffffffffff0: 00687361642f6e69 0000000000000000
==== stack proc[6] =========
```

```
0000000000400268 <_start>:
  400268:       d280001d        mov     x29, #0x0                       // #0
  40026c:       d280001e        mov     x30, #0x0                       // #0
  400270:       910003e0        mov     x0, sp
  400274:       90000001        adrp    x1, 400000 <_init-0x120>
  400278:       91000021        add     x1, x1, #0x0
  40027c:       927cec1f        and     sp, x0, #0xfffffffffffffff0
  400280:       14000001        b       400284 <_start_c>

0000000000400284 <_start_c>:
  400284:       aa0003e2        mov     x2, x0
  400288:       f0000004        adrp    x4, 403000 <__FRAME_END__+0xd90>
  40028c:       f0000003        adrp    x3, 403000 <__FRAME_END__+0xd90>
  400290:       f0000000        adrp    x0, 403000 <__FRAME_END__+0xd90>
  400294:       f947e084        ldr     x4, [x4, #4032]
  400298:       d2800005        mov     x5, #0x0                        // #0
  40029c:       f947b863        ldr     x3, [x3, #3952]
  4002a0:       f947d400        ldr     x0, [x0, #4008]
  4002a4:       f8408441        ldr     x1, [x2], #8
  4002a8:       140000bb        b       400594 <__libc_start_main>
  4002ac:       d503201f        nop

sp:    0x0000000000000000  tpidr: 0x0000000000000000
spsr:  0x0000000000000000  esr:   0x0000000092000044
elr:   0x0000000000400594  x0:    0x0000000000400150
x1:    0x00003fffffffff00  x2:    0x0000000000000008
x3:    0x0000000000400120  x4:    0x0000000000402128
x5:    0x0000000000000000  x6:    0x0000000000000000
x7:    0x0000000000000000  x8:    0x00000000000000dd
x9:    0x0000000000000000  x10:   0x0000000000000000
x11:   0x0000000000000000  x12:   0x0000000000000000
x13:   0x0000000000000000  x14:   0x0000000000000000
x15:   0x0000000000000000  x16:   0x0000000000000000
x17:   0x0000000000000000  x18:   0x0000000000000000
x19:   0x0000000000000000  x20:   0x0000000000000000
x21:   0x0000000000000000  x22:   0x0000000000000000
x23:   0x0000000000000000  x24:   0x0000000000000000
x25:   0x0000000000000000  x26:   0x0000000000000000
x27:   0x0000000000000000  x28:   0x0000000000000000
x29:   0x0000000000000000  x30:   0x0000000000000000
```

## #まで行く場合

```
in copy_strings()

# filename "/bin/init"
(gdb) p i
$3 = 31
(gdb) p offset
$4 = 4078
(gdb) p/x offset
$5 = 0xfee
(gdb) p/x bprm->p
$6 = 0x1ffee
(gdb) p/x str
$7 = 0xffff00003afe0fd0
(gdb) p str
$8 = 0xffff00003afe0fd0 "/bin/init"
(gdb) p/x bprm->page[i]
$9 = 0xffff00003afe0fa0
(gdb) p/x bprm->page[i]->page
$10 = 0xffff00003afdf000
(gdb) p/x kaddr
$14 = 0xffff00003afdf000
(gdb) p/x offset
$15 = 0xfee
(gdb) p/x kaddr+offset
$11 = 0xffff00003afdffee
(gdb) p kaddr+offset
$17 = 0xffff00003afdffee "/bin/init"

# argv[0] "/bin/init"
(gdb) p i
$20 = 31
(gdb) p/x kaddr
$21 = 0xffff00003afdf000
(gdb) p/x offset
$22 = 0xfe4
(gdb) p str
$23 = 0xffff00003afe0ff0 "/bin/init"
(gdb) p/x kaddr
$21 = 0xffff00003afdf000
(gdb) p/x offset
$22 = 0xfe4
(gdb) p str
$23 = 0xffff00003afe0ff0 "/bin/init"

in setup_arg_pages()
73	    bprm->p += stack_base;(10byte) <= bprm->p
(gdb) p/x bprm->p
$31 = 0x1ffe4
(gdb) n
(gdb) p/x bprm->p
$32 = 0xffffffffffe4

(gdb) p/x page	// bprm->page[31]
$34 = 0xffff00003afe0fa0
(gdb) p/x page->page
$35 = 0xffff00003afdf000
(gdb) p/x stack_base
$36 = 0xfffffffff000
(gdb) p/x stack_base
$37 = 0xfffffffff000
(gdb) p/x bprm->p
$38 = 0xffffffffffe4
(gdb) p (char *)bprm->p
$41 = 0xffffffffffe4 "/bin/init"
(gdb) p (char *)bprm->p+10
$42 = 0xffffffffffee "/bin/init"

in create_elf_tables()

(gdb) p/x p
$43 = 0xffffffffffe4
(gdb) p p
$44 = 0xffffffffffe4 "/bin/init"

82	        memmove(u_platform, k_platform, platform_len);
(gdb) p/x u_platform
$45 = 0xffffffffffdc
(gdb) p/x k_platform
$46 = 0xffff0000000a52d8
(gdb) n
(gdb) p u_platform
$47 = 0xffffffffffdc "aarch64"
```

```
execve: proc[1] '/bin/init' start, argc=1, envc=0
setup_arg call: addr=0x3ffffffe0000, length=0x20000
- mmap[1]: region->addr=0x3ffffffe0000, ref=0 => 0
- mmap load_pages[1]: region->addr=0x3ffffffe0000, ref=0 => 1
copyout: src=0x0, va=0x0
- mmap[1]: region->addr=0x400000, ref=0 => 0
- mmap load_pages[1]: region->addr=0x400000, ref=0 => 1
- mmap[1]: region->addr=0x403000, ref=0 => 0
- mmap load_pages[1]: region->addr=0x403000, ref=0 => 1
copyout: src=0x34366863726161, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0xf, va=0x0
copyout: src=0x3fffffffffdc, va=0x0
copyout: src=0x10, va=0x0
copyout: src=0x887, va=0x0
copyout: src=0x6, va=0x0
copyout: src=0x1000, va=0x0
copyout: src=0x11, va=0x0
copyout: src=0x64, va=0x0
copyout: src=0x3, va=0x0
copyout: src=0x400040, va=0x0
copyout: src=0x4, va=0x0
copyout: src=0x38, va=0x0
copyout: src=0x5, va=0x0
copyout: src=0x4, va=0x0
copyout: src=0x7, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0x8, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0x9, va=0x0
copyout: src=0x400268, va=0x0
copyout: src=0xb, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0xc, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0xd, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0xe, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0x17, va=0x0
copyout: src=0x0, va=0x0
copyout: src=0x33, va=0x0
copyout: src=0x1207, va=0x0
copyout: src=0x1, va=0x0
copyout: src=0x3fffffffffe4, va=0x0
copyout: src=0x580001a158000180, va=0x580001a158000180
copyout: src=0x580001a158000180, va=0x580001a158000180
start_code=0x400000, end_code=0x402274
start_data=0x403eb0, end_data=0x404108
bss=0x404108, brk=0x404790
entry=0x400268, bprm->p=0x3ffffffffea0
copyout: src=0x696e692f6e69622f, va=0x65646f6374696e69
uva_to_ka: va=0x118000, pte=0xffff00003aff98c0, *pte=0x0 not PTE_P	// binfmt_elf:L502
//				copyout(p->pgdir, p->name, bprm->filename, sizeof(p->name));のp->nameで発生x
Trap fault_addr=0x3ffffffffe80 5 times
pf_handler[1]: fault_addr: 0x3ffffffffe80, flt: 3		// このメモリを読むことはできる。書き込み時のエラー

======= PROC[1]: initcode TRAP FRAME DUMP =========
sp:    0x00003ffffffffea0  tpidr: 0x0000000000000000
spsr:  0x0000000000000000  esr:   0x000000009200004f
elr:   0x0000000000400594  x0:    0x0000000000000000
x1:    0x0000000000000001  x2:    0x00003ffffffffea8
x3:    0x0000000000400120  x4:    0x0000000000402128
x5:    0x0000000000000000  x6:    0x0000000000000000
x7:    0x0000000000000000  x8:    0x00000000000000dd
x9:    0x0000000000000000  x10:   0x0000000000000000
x11:   0x0000000000000000  x12:   0x0000000000000000
x13:   0x0000000000000000  x14:   0x0000000000000000
x15:   0x0000000000000000  x16:   0x0000000000000000
x17:   0x0000000000000000  x18:   0x0000000000000000
x19:   0x0000000000000000  x20:   0x0000000000000000
x21:   0x0000000000000000  x22:   0x0000000000000000
x23:   0x0000000000000000  x24:   0x0000000000000000
x25:   0x0000000000000000  x26:   0x0000000000000000
x27:   0x0000000000000000  x28:   0x0000000000000000
x29:   0x0000000000000000  x30:   0x0000000000000000
===================== DUMP END =====================

pagefault handler
```

```
(gdb) x/-44gx 0x400000000000
0x3ffffffffea0:	0x0000000000000001	0x00003fffffffffe4
0x3ffffffffeb0:	0x0000000000000000	0x0000000000000000
0x3ffffffffec0:	0x0000000000000010	0x0000000000000887
0x3ffffffffed0:	0x0000000000000006	0x0000000000001000
0x3ffffffffee0:	0x0000000000000011	0x0000000000000064
0x3ffffffffef0:	0x0000000000000003	0x0000000000400040
0x3fffffffff00:	0x0000000000000004	0x0000000000000038
0x3fffffffff10:	0x0000000000000005	0x0000000000000004
0x3fffffffff20:	0x0000000000000007	0x0000000000000000
0x3fffffffff30:	0x0000000000000008	0x0000000000000000
0x3fffffffff40:	0x0000000000000009	0x0000000000400268
0x3fffffffff50:	0x000000000000000b	0x0000000000000000
0x3fffffffff60:	0x000000000000000c	0x0000000000000000
0x3fffffffff70:	0x000000000000000d	0x0000000000000000
0x3fffffffff80:	0x000000000000000e	0x0000000000000000
0x3fffffffff90:	0x0000000000000017	0x0000000000000000
0x3fffffffffa0:	0x0000000000000033	0x0000000000001207
0x3fffffffffb0:	0x000000000000000f	0x00003fffffffffdc
0x3fffffffffc0:	0x0000000000000000	0x0000000000000000
0x3fffffffffd0:	0x0000000000000000	0x6372616100000000
0x3fffffffffe0:	0x6e69622f00343668	0x622f0074696e692f
0x3ffffffffff0:	0x0074696e692f6e69	0x0000000000000000
```

```
iinit: ok
init log[1]: ok
execve: proc[1] '/bin/init' start, argc=1, argv[0]=/bin/init, envc=0, envp[0]=(null)
setup_arg call: addr=0xfffffffe0000, length=0x20000
- map_region: pgdir=0xffff00003affd000, va=0xfffffffff000, pte=0xffff00003afdbff8, pa=0x3afbc000
mmaped: pgdir=0xffff00003affd000, addr=0xfffffffff000, pa=0x3afbc000
cmp[1]: addr=0xfffffffff000, pa=0x3af9c000
init: starting dash
- map_region: pgdir=0xffff00003af93000, va=0xfffffffff000, pte=0xffff00003af8dff8, pa=0x3af9c000
cml: parent[1] pgdir=0xffff00003affd000, pa=0x3af9c000
cml: child [6] pgdir=0xffff00003af93000, pa=0x3af9c000
fork: old=1, new=6
cmp[6]: addr=0xfffffffff000, pa=0x3af6b000
sys_wait4[1]: pid: -1, wstatus: 0x0, options: 0x0, rusage: 0x0
- - wait4: current=1, current->pgdir=0xffff00003affd000, pid=-1
execve: proc[6] '/bin/dash' start, argc=1, argv[0]=dash, envc=0, envp[0]=(null)
setup_arg call: addr=0xfffffffe0000, length=0x20000
- map_region: pgdir=0xffff00003af93000, va=0xfffffffff000, pte=0xffff00003af8dff8, pa=0x3af8a000
mmaped: pgdir=0xffff00003af93000, addr=0xfffffffff000, pa=0x3af8a000
cmp[6]: addr=0xfffffffff000, pa=0x3af4f000
dash main start
dash main 1
dash main 2
__expand_head: *pn=96, n=4096
sys_brk: n=0x0, sz=0x438000
- invalid n 0 return 0x438000
- brk1=0x438000
sys_brk: n=0x439000, sz=0x438000
- ok return 0x439000
- brk2=0x439000, ret=0x438000
dash main 3
dash main 4
dash main 5: login=0
dash main 6
dash main 7
dash main 8
cmdloop(1) called
# /bin/myls
pid 6, evaltree(0x436c48: 0, 0) called
evalcommand(0x436c48, 0) called
evalcommand arg: /bin/myls
redirectsafe: saveint
redirectsafe: setjump
redirectsafe: redirect
redirectsafe: err=0
redirectsafe: restoreint
redirectsafe: return err=0
redirectsafe: status=0
- map_region: pgdir=0xffff00003af0d000, va=0xfffffffff000, pte=0xffff00003af07ff8, pa=0x3af4f000
cml: parent[6] pgdir=0xffff00003af93000, pa=0x3af4f000
cml: child [7] pgdir=0xffff00003af0d000, pa=0x3af4f000
fork: old=6, new=7
cmp[7]: addr=0xfffffffff000, pa=0x3aee7000
musl call wait4: pid=-1, status=0xfffffffffb0c, dest=0
sys_wait4[6]: pid: -1, wstatus: 0xfffffffffb0c, options: 0x2, rusage: 0x0
- addr=0xfffffffff000, pa=0x3af4f000
- - wait4: current=6, current->pgdir=0xffff00003af93000, pid=-1
tryexec1: /bin/myls
path_bshell: /bin/sh
cmd: /bin/myls, argv[0]: /bin/myls, envp[0]: PWD=/.
execve: proc[7] '/bin/myls' start, argc=1, argv[0]=/bin/myls, envc=1, envp[0]=PWD=/.
setup_arg call: addr=0xfffffffe0000, length=0x20000
- map_region: pgdir=0xffff00003af0d000, va=0xfffffffff000, pte=0xffff00003af07ff8, pa=0x3af06000
mmaped: pgdir=0xffff00003af0d000, addr=0xfffffffff000, pa=0x3af06000
cmp[7]: addr=0xfffffffff000, pa=0x3af34000
??????drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
-rw-rw-r-- 159        998 trace
sys_exit: proc[7], status=0
copyout: pgdir=ffff00003af93000, va=0xfffffffffb0c, src=0xffff00000011a734, len=0x4
- uva_to_ka: pgdir=0xffff00003af93000, va=0xfffffffff000, ka=0x3af4f000
- - return 7, status=0
- wait4 return 7, status=0
unexpected interrupt 0 at cpu 0

======= PROC[6]: /bin/dash TRAP FRAME DUMP =========
sp:    0x0000fffffffffa60  tpidr: 0x00000000004363e8
spsr:  0x0000000040000000  esr:   0x0000000002000000
elr:   0x000000000041b6c4  x0:    0x0000000000000007
x1:    0x0000fffffffffb0c  x2:    0x0000000000000002
x3:    0x0000000000000000  x4:    0x000000000042d94e
x5:    0x0000000000435e84  x6:    0x000000000042d94e
x7:    0x000000007fffffff  x8:    0x0000000000000104
x9:    0x0000000000000000  x10:   0x0000000000000030
x11:   0x0000000000000000  x12:   0x696177206c6c6163
x13:   0x3d646970203a3474  x14:   0x0000000000000000
x15:   0x000000000042b7d0  x16:   0x000000000042b2e0
x17:   0x0000000000000022  x18:   0x0000fffffffffa80
x19:   0x0000fffffffffb0c  x20:   0x00000000ffffffff
x21:   0x0000000000000000  x22:   0x0000000000000002
x23:   0x0000000000000000  x24:   0x0000000000000002
x25:   0x000000000041b304  x26:   0x0000fffffffffb0c
x27:   0x0000fffffffffb90  x28:   0x0000000000000001
x29:   0x0000fffffffffa90  x30:   0x000000000041b6ac
===================== DUMP END =====================

==== stack proc[6] =========
fffffffffa60: 0000000000434000 0000fffffffffb10 0000000000000001 000000000041b668
fffffffffa80: 000000000040bb18 000000007fffffff 0000fffffffffc50 000000000040cf5c
fffffffffaa0: 0000000000438600 0000000000434000 0000000000000001 0000000000435000
fffffffffac0: 0000000000000000 0000000000436c48 0000fffffffffd58 0000000000000000
fffffffffae0: 0000000000415340 0000000000436c98 000000000040dc8c 0000000000438600
fffffffffb00: 0000fffffffffb10 000000000040ce48 0000fffffffffc80 0000000000404688
fffffffffb20: 0000fffffffffc50 000000000040cf3c 0000000000438600 0000000000000001
fffffffffb40: 0000fffffffffc50 0000fffffffffc50 0000fffffffffc10 ffffff80ffffffc8
fffffffffb60: 000000000042c5a5 0000fffffffffc50 0000fffffffffc50 0000fffffffffc10
fffffffffb80: ffffff80ffffffc8 00115409c7b4f948 3030303030303030 3030303030303030
fffffffffba0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffbc0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffbe0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fffffffffc00: 0000000000000000 0000000000000000 0000000000000000 0000000000000001
fffffffffc20: 0000000000415340 0000000000000000 0000000000434000 00000000004386ca
fffffffffc40: 6c796d2f6e69622f 00115409c7b4f948 0000fffffffffc80 00000000004047f0
fffffffffc60: 000000000042c5a5 0000000000436c78 0000000000434000 0000000000000001
fffffffffc80: 0000fffffffffd80 000000000040314c 000000000042adf8 0000000000434000
fffffffffca0: 0000000000000002 0000000000000000 0000fffffffffdd0 000000000041e220
fffffffffcc0: 0000000000415de8 0000000000000000 0000000000000000 0000000000000000
fffffffffce0: 000000000041e220 0000000100000000 0000000000000000 ffffffff00000000
fffffffffd00: 0000000000000000 0000000000436c68 0000000000436a48 0000000000000000
fffffffffd20: 0000000000000000 0000000000436c90 0000000000436c88 0000000000000000
fffffffffd40: 0000000000436c48 0000000000436c78 0000000000436c78 0000000000000000
fffffffffd60: 0000fffffffffd58 0000000000000000 00000000ffffffff 00115409c7b4f948
fffffffffd80: 0000fffffffffdf0 0000000000400554 0000000000434000 0000000000434000
fffffffffda0: 0000000000000000 000000000042b908 0000fffffffffe60 000000000040df48
fffffffffdc0: 0000000000000000 00000000004004e8 0000000000436c10 0000000000436c68
fffffffffde0: 00000000000001a8 00115409c7b4f948 0000000000000000 000000000041b260
fffffffffe00: 0000000000000001 0000fffffffffeb8 0000000000400150 0000fffffffffec8
fffffffffe20: 0000000000402000 0000000000000000 0000000100000000 0000fffffffffeb8
fffffffffe40: 0000000400000000 0000000000436c10 0000000000436c18 00000000000001f8
fffffffffe60: 0000000000436c10 0000000000436c18 00000000000001f8 00115409c7b4f948
fffffffffe80: 0000000000000000 0000000000400988 0000000000402178 0000000000403000
fffffffffea0: 0000000000000000 0000000000000000 0000000000000001 0000ffffffffffe9
fffffffffec0: 0000000000000000 0000000000000000 0000000000000010 0000000000000887
fffffffffee0: 0000000000000006 0000000000001000 0000000000000011 0000000000000064
ffffffffff00: 0000000000000003 0000000000400040 0000000000000004 0000000000000038
ffffffffff20: 0000000000000005 0000000000000004 0000000000000007 0000000000000000
ffffffffff40: 0000000000000008 0000000000000000 0000000000000009 00000000004005a0
ffffffffff60: 000000000000000b 0000000000000000 000000000000000c 0000000000000000
ffffffffff80: 000000000000000d 0000000000000000 000000000000000e 0000000000000000
ffffffffffa0: 0000000000000017 0000000000000000 0000000000000033 0000000000001207
ffffffffffc0: 000000000000000f 0000ffffffffffe1 0000000000000000 0000000000000000
ffffffffffe0: 3436686372616100 622f006873616400 00687361642f6e69 0000000000000000

==== stack proc[6] =========

Synchronous: Unknown:
  ESR_EL1 0x2000000 ELR_EL1 0x41b6c4
 SPSR_EL1 0x40000000 FAR_EL1 0x8265c4
	irq_error: irq of type 8 unimplemented.
kern/console.c:303: kernel panic at cpu 0.
```

## dashではなくosの問題だと判明

当初はbashの問題だと思って、dash側を調査していたが、wait4ではdash, sh共にエラーになる
ことに気づき、os側の問題であることが判明

```
# sh

== PRINT mmap_region[6] (mmap): head=0xffff00003afe0d20, nregions=4 ==
 - region[1]: addr=0x400000, length=0x9000, prot=0x5, flags=0x812, f=29, offset=0x0
 - region[2]: addr=0x40a000, length=0x2000, prot=0x3, flags=0x12, f=29, offset=0x9000
 - region[3]: addr=0x40c000, length=0x3000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0

# myls

== PRINT mmap_region[7] (mmap): head=0xffff00003afe0f70, nregions=4 ==
 - region[1]: addr=0x400000, length=0x8000, prot=0x5, flags=0x812, f=30, offset=0x0
 - region[2]: addr=0x408000, length=0x2000, prot=0x3, flags=0x12, f=30, offset=0x7000
 - region[3]: addr=0x40a000, length=0x1000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0

# dash

== PRINT mmap_region[6] (mmap): head=0xffff00003afe0d20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x812, f=145, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=145, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
```

## `break trapasm.S:88 if $x0==0x7` でx0, x29, x30を出力

```
$ vi .gdbinit
break trapasm.S:88 if $x0==0x7		// 返り値が7 (shがmylsをwaitした場合）
commands
silent
x/gx $x0
x/gx $x29
x/gx $x30
end

break syscall.c:566 if sysno==260	// wait4()だけbreak（sys_wait4()を呼び出す前にbreak
```

```
(gdb) c
Continuing.

Thread 1 hit Breakpoint 2, syscall (tf=0xffff00003affeed0)
    at kern/syscall.c:566
566	        tf->x0 = syscalls[sysno]();			// init waits sh
(gdb) c
Continuing.
0x7:	0xff0000000a60b800						// forkのchildのreturn
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88					// 0x404c10: <_Fork>のcall __lockの次の行
(gdb) c
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb) s
0x7:	0xff0000000a60b800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88
(gdb) bt
#0  trapret () at kern/trapasm.S:88
#1  0x0000000000404c10 in ?? ()
Backtrace stopped: previous frame inner to this frame (corrupt stack?)
(gdb) c
Continuing.
0x7:	0xff0000000a60b800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88
(gdb) c
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.

Thread 1 hit Breakpoint 2, syscall (tf=0xffff00003af94ed0)
    at kern/syscall.c:566
566	        tf->x0 = syscalls[sysno]();			// sh waits myls
(gdb) c
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f					// <printf_core>の中
(gdb) c
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f					// <printf_core>の中
(gdb)
Continuing.
0x7:	0xff0000000a60b800
0xfffffffffe20:	0x0000000000000000
0x401f50:	0x0000000000000000					// 0x401f50: call __syscall_ret
(gdb) c
Continuing.
0x7:	0xff0000000a60b800
0xfffffffffe20:	0x0000000000000000
0x401f50:	0x0000000000000000					// 0x401f50: call __syscall_ret
(gdb)
Continuing.
[Inferior 1 (process 1) exited normally]		// panic
```

```
(gdb)
Continuing.
0x7:	0xff0000000a60e800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88					// コード領域にデータあり
(gdb)
Continuing.
0x7:	0xff0000000a60e800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88					// コード領域にデータあり
(gdb)
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f					// コード領域にデータあり
(gdb)
0x7:	0xff0000000a60e800						// wait4()からのreturn
0xfffffffffe20:	0x0000000000000000
0x401f50:	0x0000000000000000					// コード領域にデータなし
(gdb) x/32gx 0xfffffffffe20									// スタック領域にはデータあり
0xfffffffffe20:	0x0000000000000000	0x0000000000401be0
0xfffffffffe30:	0x0000000000000001	0x0000fffffffffea8
0xfffffffffe40:	0x0000000000400150	0x0000fffffffffeb8
0xfffffffffe50:	0x0000000000402000	0x0000fffffffffea8
0xfffffffffe60:	0x0000000000000000	0x0000000000000000
0xfffffffffe70:	0x0000000000000000	0x0000000000400920
0xfffffffffe80:	0x0000000000402100	0x0000000000403000
0xfffffffffe90:	0x0000000000000000	0x0000000000000000
0xfffffffffea0:	0x0000000000000001	0x0000ffffffffffe6
0xfffffffffeb0:	0x0000000000000000	0x0000000000000000
0xfffffffffec0:	0x0000000000000010	0x0000000000000887
0xfffffffffed0:	0x0000000000000006	0x0000000000001000
0xfffffffffee0:	0x0000000000000011	0x0000000000000064
0xfffffffffef0:	0x0000000000000003	0x0000000000400040
0xffffffffff00:	0x0000000000000004	0x0000000000000038
0xffffffffff10:	0x0000000000000005	0x0000000000000004
(gdb) x/32gx 0x401f00										// コード領域は読めるが全部ゼロ
0x401f00:	0x0000000000000000	0x0000000000000000
0x401f10:	0x0000000000000000	0x0000000000000000
0x401f20:	0x0000000000000000	0x0000000000000000
0x401f30:	0x0000000000000000	0x0000000000000000
0x401f40:	0x0000000000000000	0x0000000000000000
0x401f50:	0x0000000000000000	0x0000000000000000
0x401f60:	0x0000000000000000	0x0000000000000000
0x401f70:	0x0000000000000000	0x0000000000000000
0x401f80:	0x0000000000000000	0x0000000000000000
0x401f90:	0x0000000000000000	0x0000000000000000
0x401fa0:	0x0000000000000000	0x0000000000000000
0x401fb0:	0x0000000000000000	0x0000000000000000
0x401fc0:	0x0000000000000000	0x0000000000000000
0x401fd0:	0x0000000000000000	0x0000000000000000
0x401fe0:	0x0000000000000000	0x0000000000000000
0x401ff0:	0x0000000000000000	0x0000000000000000
(gdb) stepi
0x00000000004044d4 in ?? ()						// ここから0x0000000000401f50に戻るはずがinterrupt
(gdb)
alltraps () at kern/trapasm.S:14
14	    stp     x29, x30, [sp, #-16]!
(gdb) c
Continuing.
0x7:	0xff0000000a60e800
0xfffffffffe20:	0x0000000000000000
0x401f50:	0x0000000000000000
(gdb)
```

## branch: dynamicで調査

```
exec[6]: sp=0x410fb8			// execve()return時のshのsp

(gdb)
0x7:	0x0000000000000000
0x410f30:	0x0000000000000000
0x401f50:	0xf84107fe97ffff84
(gdb)
0x7:	0x0000000000000000
0x410f30:	0x0000000000000000
0x401f50:	0xf84107fe97ffff84
(gdb) x/32gx 0x410f00
0x410f00:	0x000000000040b018	0x000000000040b108
0x410f10:	0x0000000000407dc8	0x000000000040b220
0x410f20:	0x00000000004001f0	0x0000000000400240
0x410f30:	0x0000000000000000	0x0000000000401be0
0x410f40:	0x0000000000000001	0x0000000000410fc0
0x410f50:	0x0000000000400150	0x0000000000410fd0
0x410f60:	0x0000000000402000	0x0000000000406fc0
0x410f70:	0x0000000000000000	0x0000000000000000
0x410f80:	0x0000000000000000	0x0000000000400920
0x410f90:	0x0000000000402100	0x0000000000403000
0x410fa0:	0x0000000000000000	0x0000000000000000
0x410fb0:	0x0000000000000000	0x0000000000000001
0x410fc0:	0x0000000000410ff0	0x0000000000000000
0x410fd0:	0x0000000000000000	0x0000000000000006
0x410fe0:	0x0000000000001000	0x0000000000000000
0x410ff0:	0x696e692f6e69622f	0x0000000000000074
(gdb) x/32gx 0x401f00
0x401f00:	0xd65f03c0a8cc53f3	0xf9400ab5b90022a0
0x401f10:	0xb900001f17ffffd7	0xaa0003e117ffffe9
0x401f20:	0x1280000052800002	0x93407c4314000001
0x401f30:	0x93407c01aa0103e2	0xd2800005d2800006
0x401f40:	0xf81f0ffed2800004	0x94000963d2802080
0x401f50:	0xf84107fe97ffff84	0xaa0003e2d65f03c0
0x401f60:	0xd28010e8d0000021	0x9137a021d2800000
0x401f70:	0xd4000001d2800103	0xaa0003e2d65f03c0
0x401f80:	0xd28010e8d0000021	0x9137c021d2800000
0x401f90:	0xd4000001d2800103	0xaa0003e1d65f03c0
0x401fa0:	0xd2800040d28010e8	0xd2800103d2800002
0x401fb0:	0xd65f03c0d4000001	0x2a0103f4a9bc53f3
0x401fc0:	0xa9015bf5aa0203f3	0xb9408c40aa0003f5
0x401fd0:	0xa9037bf9a90263f7	0xaa0203e037f802a0
0x401fe0:	0x2a0003f894000b30	0x5400092c71000696
0x401ff0:	0x51000420b9408a61	0xb9008a602a010000
(gdb) stepi
0x00000000004044d4 in ?? ()	// <__syscall_cp_c> ret
(gdb)
0x0000000000401f50 in ?? ()	// bl      401d60 <__syscall_ret>
(gdb)
0x0000000000401d60 in ?? ()	// <__syscall_ret>の先頭行
(gdb)
0x0000000000401d64 in ?? ()	//
(gdb)
0x0000000000401d68 in ?? ()
(gdb)
0x0000000000401d6c in ?? ()
(gdb)
0x0000000000401d70 in ?? ()
(gdb)
0x0000000000401d74 in ?? ()	// <__syscall_ret> ret
(gdb)
0x0000000000401f54 in ?? ()
(gdb)
0x0000000000401f58 in ?? ()	// <waitpid> ret
(gdb)
0x00000000004001f0 in ?? () // main()
(gdb)
0x00000000004001f4 in ?? ()
(gdb)
0x00000000004001f8 in ?? ()
(gdb)
0x00000000004001fc in ?? ()
(gdb)
0x0000000000400200 in ?? ()
(gdb)
0x0000000000400204 in ?? ()
(gdb)
0x0000000000400208 in ?? ()
(gdb)
0x000000000040228c in ?? ()
(gdb)
0x0000000000402290 in ?? ()
(gdb)
0x0000000000402294 in ?? ()
(gdb)
0x0000000000402298 in ?? ()
(gdb)
0x000000000040229c in ?? ()
(gdb)
0x00000000004022a0 in ?? ()
(gdb)
0x00000000004022a4 in ?? ()
(gdb)
0x00000000004022a8 in ?? ()
(gdb)
0x00000000004022ac in ?? ()
(gdb)
0x00000000004022b0 in ?? ()
(gdb)
0x00000000004022b4 in ?? ()
(gdb)
0x00000000004022b8 in ?? ()
(gdb)
0x000000000040230c in ?? ()
(gdb)
0x0000000000402310 in ?? ()
(gdb)
0x00000000004022c8 in ?? ()
(gdb)
0x00000000004022cc in ?? ()
(gdb)
0x00000000004022d0 in ?? ()
(gdb)
0x00000000004022d4 in ?? ()
(gdb)
0x00000000004021a0 in ?? ()
(gdb)
0x00000000004021a4 in ?? ()
(gdb)
0x00000000004021a8 in ?? ()
(gdb)
0x00000000004021ac in ?? ()
(gdb)
0x00000000004021b0 in ?? ()
(gdb)
0x00000000004021b4 in ?? ()
(gdb)
0x00000000004021b8 in ?? ()
(gdb)
0x00000000004021bc in ?? ()
(gdb)
0x00000000004021c0 in ?? ()
(gdb)
0x00000000004021c4 in ?? ()
(gdb)
0x00000000004021c8 in ?? ()
(gdb)
0x00000000004021cc in ?? ()
(gdb)
0x00000000004021d0 in ?? ()
(gdb)
0x00000000004021d4 in ?? ()
(gdb)
0x00000000004021d8 in ?? ()
(gdb)
0x00000000004021dc in ?? ()
(gdb)
0x00000000004021e0 in ?? ()
(gdb)
0x00000000004021e4 in ?? ()
(gdb)
0x00000000004021e8 in ?? ()
(gdb)
0x00000000004021ec in ?? ()
(gdb)
0x00000000004021f0 in ?? ()
(gdb)
0x0000000000404e90 in ?? ()
(gdb)
0x0000000000404e94 in ?? ()
(gdb)
0x0000000000404e98 in ?? ()
(gdb)
0x0000000000404e9c in ?? ()
(gdb)
0x0000000000404ea0 in ?? ()
(gdb)
0x0000000000404ea4 in ?? ()
(gdb)
0x0000000000404ea8 in ?? ()
(gdb)
0x0000000000404eac in ?? ()
(gdb)
0x0000000000404eb0 in ?? ()
(gdb)
0x0000000000404eb4 in ?? ()
(gdb)
0x0000000000404eb8 in ?? ()
(gdb)
0x0000000000404ebc in ?? ()
(gdb)
0x0000000000404ec0 in ?? ()
(gdb)
0x0000000000404ec4 in ?? ()
(gdb)
0x0000000000404ec8 in ?? ()
(gdb)
0x0000000000404ecc in ?? ()
(gdb)
0x0000000000404ed0 in ?? ()
(gdb)
0x0000000000404ed4 in ?? ()				// sys_writev  "$ " プロンプト出力
(gdb)
alltraps () at kern/trapasm.S:14
14	    stp     x29, x30, [sp, #-16]!
(gdb)
trapret () at kern/trapasm.S:88
88	    eret
(gdb)
0x0000000000404ed8 in ?? ()
(gdb)
0x0000000000401d60 in ?? ()
(gdb)
0x0000000000401d64 in ?? ()
(gdb)
0x0000000000401d68 in ?? ()
(gdb)
0x0000000000401d6c in ?? ()
(gdb)
0x0000000000401d70 in ?? ()
(gdb)
0x0000000000401d74 in ?? ()
(gdb)
0x0000000000404edc in ?? ()
(gdb)
0x0000000000404ee0 in ?? ()
(gdb)
0x0000000000404ee4 in ?? ()
```

## mylsの実行後にコード領域が0クリアされていることを発見

```
(gdb) x/32gx 0x401f00
0x401f00:	0x5100067351000af7	0x1b087c0017ffff8a
0x401f10:	0x1ac0086111000442	0x34ffff811b008c21
0x401f20:	0x321b02e1cb070340	0x93407e7393407c42
0x401f30:	0x7101983f9342fc00	0x8b000c00d1000400
0x401f40:	0xeb02000054000c81	0xeb13001f9a9f5000
0x401f50:	0x321f77e09a93d013	0x54ffcdaa6b00027f
0x401f60:	0xb90083e0121d0320	0x110006682a000260
0x401f70:	0xb90063e07100001f	0x321b02fc1a880508
0x401f80:	0x71019b9f12b0000b	0x54000a614b08016b
0x401f90:	0x54ffcbec6b0b009f	0x5400004d7100009f
0x401fa0:	0x710002bf0b040108	0x12b00000f9004fe7
0x401fb0:	0x1a810000321f77e1	0x54ffcaab6b08001f
0x401fc0:	0x2a1903e40b150117	0x2a1603e22a1703e3
0x401fd0:	0x52800401aa1403e0	0x93407ea297fffd51
0x401fe0:	0xaa1403e0aa1803e1	0x5210032497fffd45
0x401ff0:	0x2a1603e22a1703e3	0x52800601aa1403e0
(gdb) c
Continuing.

Thread 1 hit Breakpoint 2, syscall (tf=0xffff00003af94ed0)
    at kern/syscall.c:567
567	        if (sysno == 260) {
(gdb) x/32gx 0x401f00
0x401f00:	0x0000000000000000	0x0000000000000000
0x401f10:	0x0000000000000000	0x0000000000000000
0x401f20:	0x0000000000000000	0x0000000000000000
0x401f30:	0x0000000000000000	0x0000000000000000
0x401f40:	0x0000000000000000	0x0000000000000000
0x401f50:	0x0000000000000000	0x0000000000000000
0x401f60:	0x0000000000000000	0x0000000000000000
0x401f70:	0x0000000000000000	0x0000000000000000
0x401f80:	0x0000000000000000	0x0000000000000000
0x401f90:	0x0000000000000000	0x0000000000000000
0x401fa0:	0x0000000000000000	0x0000000000000000
0x401fb0:	0x0000000000000000	0x0000000000000000
0x401fc0:	0x0000000000000000	0x0000000000000000
0x401fd0:	0x0000000000000000	0x0000000000000000
0x401fe0:	0x0000000000000000	0x0000000000000000
0x401ff0:	0x0000000000000000	0x0000000000000000
```

```
(gdb) c
Continuing.
0x7:	0xff0000000a60e800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88
(gdb) x/2gx 0x401f50
0x401f50:	0xf84107fe97ffff84	0xaa0003e2d65f03c0
(gdb) c
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.
0x7:	0xff0000000a60e800
0xfffffffffe20:	0x0000000000000000
0x404c10:	0xd2800220d2801b88
(gdb) x/2gx 0x401f50
0x401f50:	0xf84107fe97ffff84	0xaa0003e2d65f03c0
(gdb) c
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.
0x7:	Cannot access memory at address 0x7

// fork: old=6, new=7
// sys_wait4[6]: pid: -1, wstatus: 0x0, options: 0x0, rusage: 0x0
// - - wait4: current=6 waits pid=-1, status=0x0

(gdb) x/2gx 0x401f50
0x401f50:	0xf84107fe97ffff84	0xaa0003e2d65f03c0
(gdb) c
Continuing.
0x7:	Cannot access memory at address 0x7
(gdb)
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f

// start_code=0x400000, end_code=0x4075d8
// start_data=0x408ec8, end_data=0x4091f0
// bss=0x4091f0, brk=0x40a868
// entry=0x4001a8, bprm->p=0xfffffffffea0

(gdb) c
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f
(gdb)
Continuing.
0x7:	0x0000000000000000
0x0:	0x0000fffffffffeb8
0x403660:	0x5400030b7100001f									// コードあり
(gdb)
Continuing.

Thread 1 hit Breakpoint 2, syscall (tf=0xffff00003af94ed0)
    at kern/syscall.c:567
567	        if (sysno == 260) {
(gdb) x/2gx 0x401f50
0x401f50:	0x0000000000000000	0x0000000000000000				// 0クリア

// drwxrwxr-x   1       4096 .
// drwxrwxr-x   1       4096 ..
// drwxrwxr-x   2       8448 bin
// drwxrwxr-x   3        384 dev
// drwxrwxr-x   8        320 etc
// drwxrwxrwx   9        192 lib
// drwxrwxr-x  10        192 home
// drwxrwxr-x  12        192 usr
// sys_exit: proc[7], status=0
// - - destroy 7
// - - return 7, status=0 &status=0x0
```

## wait4()のsleepの前後で消えていることを発見

```
$ /bin/myls
- map_region[6]: va=0x401000, pa=0x3af4c000, pa[0]=0x0
==== memory dump [6]: (wait4: before sleep) =========
000000401f50: 84ffff97 fe0741f8 c0035fd6 e20300aa
==== memory dump =========

==== memory dump [6]: (wait4: before sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000
==== memory dump =========

execve: proc[7] '/bin/myls' start, argc=1, argv[0]=/bin/myls, envc=0, envp[0]=(null)
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sys_exit: proc[7], status=0
==== memory dump [6]: (wait4: after  sleep) =========
000000401f50: 00000000 00000000 00000000 00000000			// map: 0x400000 が消えている
==== memory dump =========

==== memory dump [6]: (wait4: after  sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000			// map: 0x40a000 はある
==== memory dump =========
```

## sleep前後のcurrent

```
$2 = {
  sz = 0x40f000,
  pgdir = 0xffff00003af93000,
  kstack = 0xffff00003af94000,
  state = 0x4,
  pid = 0x6,
  tf = 0xffff00003af94ed0,
  context = 0xffff00003af94d70,
  nregions = 0x4,
  head = 0xffff00003afe0d20,
}

# sleep

(gdb) p/x *current
$3 = {
  sz = 0x40f000,
  pgdir = 0xffff00003af93000,
  kstack = 0xffff00003af94000,
  state = 0x4,
  pid = 0x6,
  tf = 0xffff00003af94ed0,
  context = 0xffff00003af94d00,
  nregions = 0x4,
  head = 0xffff00003afe0d20,
}
```

## map_region

```
Thread 1 hit Breakpoint 1, map_region (pgdir=0xffff00003af37000, va=0x401000,
    size=4096, pa=989118464, perm=9007199254742983) at kern/vm.c:85
85	        if (thisproc()->pid == 6 && va == (void *)0x401000)
(gdb) bt
#0  map_region (pgdir=0xffff00003af37000, va=0x401000, size=4096,
    pa=989118464, perm=9007199254742983) at kern/vm.c:85
#1  0xffff00000009ec04 in copy_mmap_list (
    parent=0xffff000000119e20 <ptable+9904>,
    child=0xffff00000011a5d8 <ptable+11880>) at kern/mmap.c:659
#2  0xffff00000008c94c in fork () at kern/proc.c:403
#3  0xffff00000009bae0 in sys_clone () at kern/sysproc.c:94
#4  0xffff00000009090c in syscall (tf=0xffff00003af94ed0) at kern/syscall.c:566
#5  0xffff0000000823ac in trap (tf=0xffff00003af94ed0) at kern/trap.c:185
#6  0xffff000000090a80 in alltraps () at kern/trapasm.S:52
#7  0x0000000000000000 in ?? ()
Backtrace stopped: not enough registers or memory available to unwind further
(gdb) c
Continuing.

Thread 1 hit Breakpoint 1, map_region (pgdir=0xffff00003af37000, va=0x401000,
    size=4096, pa=988766208, perm=9007199254742983) at kern/vm.c:85
85	        if (thisproc()->pid == 6 && va == (void *)0x401000)
(gdb) bt
#0  map_region (pgdir=0xffff00003af37000, va=0x401000, size=4096,
    pa=988766208, perm=9007199254742983) at kern/vm.c:85
#1  0xffff00000009da78 in map_file_page (addr=0x401000, length=4096,
    perm=9007199254742983, f=0xffff0000001100d8 <ftable+168>, offset=0)
    at kern/mmap.c:229
#2  0xffff00000009db10 in map_file_pages (addr=0x400000, length=30168,
    perm=9007199254742983, f=0xffff0000001100d8 <ftable+168>, offset=0)
    at kern/mmap.c:247
#3  0xffff00000009dd20 in mmap_load_pages (addr=0x400000, length=30168,
    prot=5, flags=2066, f=0xffff0000001100d8 <ftable+168>, offset=0)
    at kern/mmap.c:303
#4  0xffff00000009e320 in mmap (addr=0x400000, length=30168, prot=5,
    flags=2066, f=0xffff0000001100d8 <ftable+168>, offset=0) at kern/mmap.c:458
#5  0xffff000000082f34 in elf_map (f=0xffff0000001100d8 <ftable+168>,
    addr=4194304, eppnt=0xffff00003afe0b20, prot=5, flags=2066)
    at kern/binfmt_elf.c:40
#6  0xffff000000083cf0 in load_elf_binary (bprm=0xffff00003af388f0)
    at kern/binfmt_elf.c:397
#7  0xffff00000008f494 in search_binary_handler (bprm=0xffff00003af388f0)
    at kern/exec.c:327
#8  0xffff00000008f760 in do_execve (
    path=0x40b230 <error: Cannot access memory at address 0x40b230>, argc=1,
    envc=0, argv=0xffff00003af38d20, envp=0xffff00003af38b20)
    at kern/exec.c:403
--Type <RET> for more, q to quit, c to continue without paging--
#9  0xffff0000000930c8 in sys_execve () at kern/sysfile.c:909
#10 0xffff00000009090c in syscall (tf=0xffff00003af38ed0) at kern/syscall.c:566
#11 0xffff0000000823ac in trap (tf=0xffff00003af38ed0) at kern/trap.c:185
#12 0xffff000000090a80 in alltraps () at kern/trapasm.S:52
#13 0x0000000000000000 in ?? ()
Backtrace stopped: not enough registers or memory available to unwind further
```

## sleep前後の0x400000の内容をチェック

```
(gdb) bt
#0  wait4 (pid=-1, status=0x0, options=0, ru=0x0) at kern/proc.c:544
#1  0xffff00000009bc4c in sys_wait4 () at kern/sysproc.c:120
#2  0xffff0000000909ec in syscall (tf=0xffff00003af94ed0) at kern/syscall.c:566
#3  0xffff0000000823ac in trap (tf=0xffff00003af94ed0) at kern/trap.c:185
#4  0xffff000000090b60 in alltraps () at kern/trapasm.S:52
#5  0x0000000000000000 in ?? ()
Backtrace stopped: not enough registers or memory available to unwind further

// memset4: addr=0xffff00003af4c000
//- map_region[6]: va=0x401000, pa=0x3af4c000, pa[0]=0x0

(gdb) x/6gx 0x400000
0x400000:	0x00010102464c457f	0x0000000000000000		// paの内容
0x400010:	0x0000000100b70002	0x00000000004002fc
0x400020:	0x0000000000000040	0x0000000000015b68
(gdb) c
Continuing.

// sleep

(gdb) x/6gx 0x400000
0x400000:	0xffff00003af4c000	0x0000000000000000		// pteアドレスに変更されている
0x400010:	0x0000000000000000	0x0000000000000000
0x400020:	0x0000000000000000	0x0000000000000000
```

## sched()の0x400000の内容をチェック

```
==== memory dump [6]: (before sched()) =========
000000400000: 7f454c46 02010100 00000000 00000000
==== memory dump =========

sched(): from proc 6
sched(): to proc 2
sched(): from proc 2
sched(): to proc 3
sched(): from proc 3
sched(): to proc 4
sched(): from proc 4
sched(): to proc 5
sched(): from proc 5
...

$ /bin/myls

...
sched(): to proc 6
==== memory dump [6]: (after sched()) =========
000000400000: 7f454c46 02010100 00000000 00000000				// waitするまではsched()前後で問題なし
																// context switchの問題ではない
==== memory dump =========
...
==== memory dump [6]: (after sched()) =========
000000400000: 7f454c46 02010100 00000000 00000000
==== memory dump =========

- map_region[6]: va=0x401000, pa=0x3af4c000, pa[0]=0x0
wait4: pgdir=0xffff00003af93000, addr=0x400000, pa=0x3af6a000
==== memory dump [6]: (wait4: before sleep) =========
000000400000: 7f454c46 02010100 00000000 00000000
==== memory dump =========

==== memory dump [6]: (wait4: before sleep) =========
000000401f50: 84ffff97 fe0741f8 c0035fd6 e20300aa
==== memory dump =========

==== memory dump [6]: (wait4: before sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000
==== memory dump =========

==== memory dump [6]: (before sched()) =========
000000400000: 7f454c46 02010100 00000000 00000000				// ここまでは正常
==== memory dump =========
...
sched(): to proc 7
execve: proc[7] '/bin/myls' start, argc=1, argv[0]=/bin/myls, envc=0, envp[0]=(null)
sched(): from proc 7
sched(): to proc 2
...
sched(): to proc 7
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sched(): from proc 7
sched(): to proc 2
...
sched(): to proc 7
sys_exit: proc[7], status=0
sched(): from proc 7
sched(): to proc 2
...
sched(): from proc 5
sched(): to proc 6
==== memory dump [6]: (after sched()) =========					// wait->sleep->wakeup->schedの間
000000400000: 00c0f43a 0000ffff 00000000 00000000				// ここでおかしくなっている
==== memory dump =========

wait4: pgdir=0xffff00003af93000, addr=0x400000, pa=0x3af6a000
==== memory dump [6]: (wait4: after  sleep) =========
000000400000: 00c0f43a 0000ffff 00000000 00000000
==== memory dump =========

==== memory dump [6]: (wait4: after  sleep) =========
000000401f50: 00000000 00000000 00000000 00000000
==== memory dump =========

==== memory dump [6]: (wait4: after  sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000
==== memory dump =========

return sys_wait4[6]: 7
==== memory dump [6]: (before sched()) =========
000000400000: 00c0f43a 0000ffff 00000000 00000000
==== memory dump =========
```

0x40000に書かれている0xffff00003af4c000は、0x401000のpteアドレス

## uvm_unmapで開放されているpaを出力

```
execve: proc[7] '/bin/myls' start, argc=1, argv[0]=/bin/myls, envc=0, envp[0]=(null)
uvm_unmap[989241344]: free pa=0x3af6a000, *pte=0x1
uvm_unmap[989118464]: free pa=0x3af4c000, *pte=0x0	 // <= これが0x401000のpa で削除されている
uvm_unmap[989106176]: free pa=0x3af49000, *pte=0x0
...
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sys_exit: proc[7], status=0
```

## 解決

- 原因は子プロセスが親プロセスからコピーしたコードregionを削除する際に、物理メモリを
  削除していたため
- プログラムのコードregionはMAP_SHAREとして、MAP_SHAREでregion->ref_count > 0の
  場合は、uvm_unmap(,,,0)としてページのunmapのみして、物理メモリは削除しないようにした。

```
$ /bin/myls
- map_region[6]: va=0x401000, pa=0x3af49000, pa[0]=0x0
wait4: pgdir=0xffff00003af93000, addr=0x400000, pa=0x3af6a000
==== memory dump [6]: (wait4: before sleep) =========
000000400000: 7f454c46 02010100 00000000 00000000
==== memory dump =========

==== memory dump [6]: (wait4: before sleep) =========
000000401f50: 84ffff97 fe0741f8 c0035fd6 e20300aa
==== memory dump =========

==== memory dump [6]: (wait4: before sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000
==== memory dump =========

execve: proc[7] '/bin/myls' start, argc=1, argv[0]=/bin/myls, envc=0, envp[0]=(null)
fml[7]: ref=1
dmn[7]: addr=0x400000, private=0, ref=1
fml[7]: ref=1
dmn[7]: addr=0x40a000, private=2, ref=1
fml[7]: ref=1
dmn[7]: addr=0x40c000, private=2, ref=1
fml[7]: ref=1
dmn[7]: addr=0xfffffffe0000, private=2, ref=1
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
sys_exit: proc[7], status=0
fml[7]: ref=0
dmn[7]: addr=0x400000, private=0, ref=0
fml[7]: ref=0
dmn[7]: addr=0x408000, private=2, ref=0
fml[7]: ref=0
dmn[7]: addr=0x40a000, private=2, ref=0
fml[7]: ref=0
dmn[7]: addr=0xfffffffe0000, private=2, ref=0
wait4: pgdir=0xffff00003af93000, addr=0x400000, pa=0x3af6a000
==== memory dump [6]: (wait4: after  sleep) =========
000000400000: 7f454c46 02010100 00000000 00000000
==== memory dump =========

==== memory dump [6]: (wait4: after  sleep) =========
000000401f50: 84ffff97 fe0741f8 c0035fd6 e20300aa
==== memory dump =========

==== memory dump [6]: (wait4: after  sleep) =========
00000040ae50: 00000000 00000000 f8034000 00000000
==== memory dump =========

return sys_wait4[6]: 7
$ 															// <= mylsが正常終了し、プロンプトがでた
```

デバッグ出力を削除

```
iinit: ok
init log[1]: ok
init: starting dash
$ /bin/myls
drwxrwxr-x   1       4096 .
drwxrwxr-x   1       4096 ..
drwxrwxr-x   2       8448 bin
drwxrwxr-x   3        384 dev
drwxrwxr-x   8        320 etc
drwxrwxrwx   9        192 lib
drwxrwxr-x  10        192 home
drwxrwxr-x  12        192 usr
$ /bin/mmaptest
mmap_testスタート
- open mmap.dur (fd=3) READ ONLY
[1] test mmap f
sys_mmap: addr=0x0, length=0x2000, prot=0x1, flags=0x2, f=159, offset=0x0
- return 0x40d000
- mmap fd=3 -> 2ページ分PROT_READ MAP_PRIVATEでマップ: addr=0x40d000
sys_munmap: addr=0x40d000, length=0x2000
- found: addr=0x40d000
- return 0x0
- munmmap 2PAGE: addr=0x40d000
[1] OK
[2] test mmap private
sys_mmap: addr=0x0, length=0x2000, prot=0x3, flags=0x2, f=159, offset=0x0
- return 0x40d000
- mmap fd=3 -> 2ページ分をPAGE PROT_READ/WRITE, MAP_PRIVATEでマップ: addr=0x40d000
- closed 3
- write 2PAGE = Z
- p[1]=A
sys_munmap: addr=0x40d000, length=0x2000
- found: addr=0x40d000
- return 0x0
- munmmap 2PAGE: addr=0x40d000
[2] OK
[3] test mmap read-only
- open mmap.dur (3) RDONALY
- mmap 3 -> 3PAGE PROT_READ/WRITE MAP_SHARED: addr=0xffffffffffffffff
- close 3
[3] OK
[4] test mmap read/write
- open mmap.dur (3) RDWR
sys_mmap: addr=0x0, length=0x3000, prot=0x3, flags=0x1, f=159, offset=0x0
- return 0x40d000
- mmap 3 -> 3PAGE PROT_READ|WRITE MAP_SHARED: addr=0x40d000
- close 3
- print 2PAGE = Z
sys_munmap: addr=0x40d000, length=0x2000
- found: addr=0x40d000
- return 0x0
- munmmap 2PAGE: addr=0x40d000
[4] OK
[5] test mmap dirty
- open mmap.dur (3) RDWR
- close 3
[5] OK
[6] test not-mapped unmap
sys_munmap: addr=0x40f000, length=0x1000
- found: addr=0x40f000
- return 0x0
- munmmap PAGE: addr=0x40f000
[6] OK
[7] test mmap two files
- open mmap1 (3) RDWR/CREAT
sys_mmap: addr=0x0, length=0x1000, prot=0x1, flags=0x2, f=160, offset=0x0
- return 0x40d000
- mmap 3 -> PAGE PROT_READ MAP_PRIVATE: addr=0x40d000
- close 3
- unlink mmap1
- open mmap2 (3) RDWR/CREAT
sys_mmap: addr=0x0, length=0x1000, prot=0x1, flags=0x2, f=161, offset=0x0
- return 0x40e000
- mmap 3 -> PAGE PROT_READ MAP_PRIVATE: addr=0x40e000
- close 3
- unlink mmap2
sys_munmap: addr=0x40d000, length=0x1000
- found: addr=0x40d000
- return 0x0
- munmap PAGE: addr=0x40d000
sys_munmap: addr=0x40e000, length=0x1000
- found: addr=0x40e000
- return 0x0
- munmap PAGE: addr=0x40e000
[7] OK
mmap_test: Total: 7, OK: 7, NG: 0

fork_test starting
sys_mmap: addr=0x0, length=0x2000, prot=0x1, flags=0x1, f=162, offset=0x0
- return 0x40d000
sys_mmap: addr=0x0, length=0x2000, prot=0x1, flags=0x1, f=162, offset=0x0
- return 0x40f000
p1[PGSIZE]=A
p2[PGSIZE]=A
sys_munmap: addr=0x40d000, length=0x1000
- found: addr=0x40d000
- return 0x0
mismatch at 0, wanted 'A', got 0x0, addr=0x40d000
mismatch at 1, wanted 'A', got 0x30, addr=0x40d001
mismatch at 2, wanted 'A', got 0xe8, addr=0x40d002
mismatch at 3, wanted 'A', got 0x3a, addr=0x40d003
mismatch at 4, wanted 'A', got 0x0, addr=0x40d004
mismatch at 5, wanted 'A', got 0x0, addr=0x40d005
mismatch at 6, wanted 'A', got 0xff, addr=0x40d006
mismatch at 7, wanted 'A', got 0xff, addr=0x40d007
- fork parent v1(p1): ret: -8
sys_munmap: addr=0x40d000, length=0x2000
- found: addr=0x40d000
- return 0x0
sys_munmap: addr=0x40f000, length=0x2000
- found: addr=0x40f000
- return 0x0
fork_test OK
mmaptest: all tests succeeded
$
```

# ただし、dashではエラー

やはり、wait4でエラー。dash固有の問題があるのか。

```
# myls
musl call wait4: pid=-1, status=0xfffffffffb1c, dest=0
unexpected interrupt 0 at cpu 0
```

## ref_countの増減がおかしい

```
# ls -l
At fork tart: [6] sp=0xfffffffffb10, *sp=0x40c708
== PRINT mmap_region[6] (/bin/dash): head=0xffff00003afe0d20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
== PRINT mmap_region[7] (child): head=0xffff00003afe0f20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
At fork end : parent [6] sp=0xfffffffffb10, *sp=0x40c708
At fork end : child  [7] sp=0xfffffffffb10, *sp=0x40c708
delete_mmap_node[7]: addr=0x400000, ref=1                       # <= 1
delete_mmap_node[7]: addr=0x431000, ref=1
delete_mmap_node[7]: addr=0x434000, ref=1
delete_mmap_node[7]: addr=0x436000, ref=1
delete_mmap_node[7]: addr=0xfffffffe0000, ref=1
total 11
drwxrwxr-x 1 root root 8448 Mar  6  2022 bin
drwxrwxr-x 1 root root  384 Mar  6  2022 dev
drwxrwxr-x 1 root root  320 Mar  6  2022 etc
drwxrwxr-x 1 root root  192 Mar  6  2022 home
drwxrwxrwx 1 root root  192 Mar  6  2022 lib
drwxrwxr-x 1 root root  192 Mar  6  2022 usr
delete_mmap_node[7]: addr=0x400000, ref=0                       # <= 0
delete_mmap_node[7]: addr=0x440000, ref=0
delete_mmap_node[7]: addr=0x443000, ref=0
delete_mmap_node[7]: addr=0x445000, ref=0
delete_mmap_node[7]: addr=0xfffffffe0000, ref=0
# ls
At fork tart: [6] sp=0xfffffffffb10, *sp=0x40c708
== PRINT mmap_region[6] (/bin/dash): head=0xffff00003afe0d20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
== PRINT mmap_region[8] (child): head=0xffff00003afe0f20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
At fork end : parent [6] sp=0xfffffffffb10, *sp=0x40c708
At fork end : child  [8] sp=0xfffffffffb10, *sp=0x40c708
delete_mmap_node[8]: addr=0x400000, ref=2                       # <= 2
delete_mmap_node[8]: addr=0x431000, ref=2
delete_mmap_node[8]: addr=0x434000, ref=2
delete_mmap_node[8]: addr=0x436000, ref=2
delete_mmap_node[8]: addr=0xfffffffe0000, ref=2
bin  dev  etc  home  lib  usr
delete_mmap_node[8]: addr=0x400000, ref=0                       # <= 0
delete_mmap_node[8]: addr=0x440000, ref=0
delete_mmap_node[8]: addr=0x443000, ref=0
delete_mmap_node[8]: addr=0x445000, ref=0
delete_mmap_node[8]: addr=0xfffffffe0000, ref=0
# ls
At fork tart: [6] sp=0xfffffffffb10, *sp=0x40c708
== PRINT mmap_region[6] (/bin/dash): head=0xffff00003afe0d20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
== PRINT mmap_region[9] (child): head=0xffff00003afe0f20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
At fork end : parent [6] sp=0xfffffffffb10, *sp=0x40c708
At fork end : child  [9] sp=0xfffffffffb10, *sp=0x40c708
delete_mmap_node[9]: addr=0x400000, ref=3                       # <= 3
delete_mmap_node[9]: addr=0x431000, ref=3
delete_mmap_node[9]: addr=0x434000, ref=3
delete_mmap_node[9]: addr=0x436000, ref=3
delete_mmap_node[9]: addr=0xfffffffe0000, ref=3
bin  dev  etc  home  lib  usr
delete_mmap_node[9]: addr=0x400000, ref=0                       # <= 0
delete_mmap_node[9]: addr=0x440000, ref=0
delete_mmap_node[9]: addr=0x443000, ref=0
delete_mmap_node[9]: addr=0x445000, ref=0
delete_mmap_node[9]: addr=0xfffffffe0000, ref=0
# readelf -l /bin/cat
At fork tart: [6] sp=0xfffffffffb10, *sp=0x40c708
== PRINT mmap_region[6] (/bin/dash): head=0xffff00003afe0d20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
== PRINT mmap_region[10] (child): head=0xffff00003afe0f20, nregions=5 ==
 - region[1]: addr=0x400000, length=0x30000, prot=0x5, flags=0x811, f=144, offset=0x0
 - region[2]: addr=0x431000, length=0x3000, prot=0x3, flags=0x12, f=144, offset=0x30000
 - region[3]: addr=0x434000, length=0x2000, prot=0x3, flags=0x32, f=0, offset=0x0
 - region[4]: addr=0x436000, length=0x1000, prot=0x3, flags=0x8032, f=0, offset=0x0
 - region[5]: addr=0xfffffffe0000, length=0x20000, prot=0x7, flags=0x32, f=0, offset=0x0
At fork end : parent [6] sp=0xfffffffffb10, *sp=0x40c708
At fork end : child  [10] sp=0xfffffffffb10, *sp=0x40c708
delete_mmap_node[10]: addr=0x400000, ref=4                       # <= 4
delete_mmap_node[10]: addr=0x431000, ref=4
delete_mmap_node[10]: addr=0x434000, ref=4
delete_mmap_node[10]: addr=0x436000, ref=4
delete_mmap_node[10]: addr=0xfffffffe0000, ref=4

Elf file type is EXEC (Executable file)
Entry point 0x400eac
There are 4 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
                 0x0000000000018584 0x0000000000018584  R E    0x1000
  LOAD           0x00000000000189b0 0x00000000004199b0 0x00000000004199b0
                 0x0000000000000958 0x0000000000001a88  RW     0x1000
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10
  GNU_RELRO      0x00000000000189b0 0x00000000004199b0 0x00000000004199b0
                 0x0000000000000650 0x0000000000000650  R      0x1

 Section to Segment mapping:
  Segment Sections...
   00     .init .text .fini .rodata .eh_frame
   01     .init_array .fini_array .data.rel.ro .got .got.plt .data .bss
   02
   03     .init_array .fini_array .data.rel.ro .got .got.plt
delete_mmap_node[10]: addr=0x400000, ref=0                       # <= 0
delete_mmap_node[10]: addr=0x4f5000, ref=0
delete_mmap_node[10]: addr=0x4fc000, ref=0
delete_mmap_node[10]: addr=0x500000, ref=0
delete_mmap_node[10]: addr=0xfffffffe0000, ref=0
# QEMU: Terminated
```

## free_mmap_list()にデバッグ出力

```
# ls
exec: call fml [7]
fml[7]: addr=0x400000, copied           // 親から受け継いだmmapを削除
fml[7]: addr=0x431000, copied
fml[7]: addr=0x434000, copied
fml[7]: addr=0x436000, copied
fml[7]: addr=0xfffffffe0000, copied
bin  dev  etc  home  lib  usr
exit: call fml [7]                      // 自分のmmapを削除
fml[7]: addr=0x400000, org
fml[7]: addr=0x440000, org
fml[7]: addr=0x443000, org
fml[7]: addr=0x445000, org
fml[7]: addr=0xfffffffe0000, org
