# 14. スタティック変数

## 14.1 概要

Linuxは`C`言語で書かれており、すべてのアプリケーションは以下を持っています。

1. ローカル変数
2. モジュール変数（ソースファイルにあり、モジュールにのみ関連するもの）
3. コピーが1つしか無いグローバル/スタティック変数（すべてのモジュールで同じもの）

あるモジュールがスタティック変数を変更するとすべてのモジュールはその新しい値を見る
ことになります。

Linuxではスタティック変数は非常に重要です。カーネルに新しいサポートを追加する
唯一のものからです。通常、スタティック変数は登録された要素のリストの先頭への
ポインタであり、以下の操作が可能です。

- 追加
- 削除
- 変更（たぶん）

```
                           _______      _______      _______
Global variable  -------> |Item(1)| -> |Item(2)| -> |Item(3)|  ..
                          |_______|    |_______|    |_______|
```

## 14.2 主な変数

### `Current`

```
                           ________________
Current ----------------> | Actual process |
                          |________________|
```

`Current`は`task_struct`構造体を指しており、この構造体にはプロセスに関する
次のような全てのデータが入っています。

- pid, 名前, 状態, カウンタ, スケジューリングポリシー
- ファイル、vfs、他のプロセス、シグナルなど、多くのデータ構造体へのポインタ。

`Current`は実変数ではなく、次のように定義されています。

```c
static inline struct task_struct * get_current(void) {
   struct task_struct *current;
   __asm__("andl %%esp,%0; ":"=r" (current) : "0" (~8191UL));
   return current;
}
#define current get_current()
```

ここでは`esp`レジスタ（スタックポインタ）の値を変数として取得し、`task_struct`
構造体を指すようにしただけです。

`current`要素からは（ready, stopped, その他任意の状態の）他のプロセスのカーネル
データ構造体に直接アクセスできます。たとえば、STATE（I/Oドライバが行うように）、
PID、readyリストやブロックリストのエントリなどを変更できます。

### 登録済みファイルシステム

```
                       ______      _______      ______
file_systems  ------> | ext2 | -> | msdos | -> | ntfs |
 [fs/super.c]         |______|    |_______|    |______|
```

`modprobe some_fs`のようなコマンドを使うことでファイルシステムリストに新しい
エントリを追加することができます。また、（`rmmod`コマンドを使って）削除する
ことができます。

### マウント済みファイルシステム

```
                        ______      _______      ______
mount_hash_table  ---->|   /  | -> | /usr  | -> | /var |
[fs/namespace.c]       |______|    |_______|    |______|
```

`mount`コマンドを使ってファイルシステムを追加すると新しいエントリがこのリストに
挿入されます。また、`umount`コマンドはエントリを削除します。

### 登録済みネットワークパケット種別

```
                        ______      _______      ______
     ptype_all  ------>|  ip  | -> |  x25  | -> | ipv6 |
[net/core/dev.c]       |______|    |_______|    |______|
```

たとえば、（関連するモジュールをロードして）IPv6をサポートしたら新しいエントリが
このリストに追加されます。

### 登録済みネットワーク内部プロトコル

```
                          ______      _______      _______
inet_protocol_base ----->| icmp | -> |  tcp  | -> |  udp  |
[net/ipv4/protocol.c]    |______|    |_______|    |_______|
```

同様に（IPv6などの）他のパケットタイプも各自のリストに多くの内部プロトコルを
持っています。

```
                          ______      _______      _______
inet6_protos ----------->|icmpv6| -> | tcpv6 | -> | udpv6 |
[net/ipv6/protocol.c]    |______|    |_______|    |_______|
```

### 登録済みネットワークデバイス

```
                          ______      _______      _______
dev_base --------------->|  lo  | -> |  eth0 | -> |  ppp0 |
[drivers/core/Space.c]   |______|    |_______|    |_______|
```

### 登録済みキャラクタデバイス

```
                          ______      _______      ________
chrdevs ---------------->|  lp  | -> | keyb  | -> | serial |
[fs/devices.c]           |______|    |_______|    |________|
```

`chrdevs`は実リストへのポインタではなく、標準的なベクタです。

### 登録済みブロックデバイス

```
                          ______      ______      ________
bdev_hashtable --------->|  fd  | -> |  hd  | -> |  scsi  |
[fs/block_dev.c]         |______|    |______|    |________|
```

`bdev_hashtable`はハッシュベクタです。
