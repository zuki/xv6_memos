# メールボックス属性インタフェース


- レスポンスはリクエストを上書きします
    - calleeが別のバッファアドレスを返すことは許されません。これにより
      callerは独立した非同期リクエストを行うことができます。
- バッファ自体は16バイトアラインされます。メールボックス経由で渡すことが
  できるのはアドレスの上位28ビットだけだからです。
- u64/u32/u16の値はすべてホストCPUのエンディアンオーダーです。
- 未知のタグは無視されます（レスポンスビットはセットされません）。
- レスポンスには未承諾のタグを含めることができます。
- 追加情報が将来のフォーマットで提供されるのであれば、レスポンスタグ長を
  期待する長さより長くすることができます。
    - レスポンスは提供されたバッファ長さに切り詰められます。
    - バッファが以前のバージョンで必要とされるサイズである場合、切り捨て
      られる部分が以前のバージョンと同様に読み取ることができるようにする
      互換性のない変更には新しいタグが必要となります。
    - レスポンス長はバッファサイズより長い場合であっても必要な長さを示します。
    - タグ値の長さは、リクエスト/レスポンスのバージョンを推測するために
      使用することができます。
- タグは（フレームバッファのように）インタフェースが一つの操作に複数の
  タグを必要とする場合を除いて順番に処理されるはずである。

## メールボックスメッセージ。

- メールボックスインタフェースは、値として使える28ビット（MSB）と
  チャネルとして使える4ビット（LSB）を持ちます。
    - リクエストメッセージ: 28ビット(MSB)のバッファアドレス
    - レスポンスメッセージ: 28ビット(MSB)のバッファアドレス
- チャネル8と9が使用されます。
    - チャネル8: ARMがリクエストしてVCがレスポンスする
    - チャネル9: VCがリクエストしてARMがレスポンスする（現在定義なし）

## バッファコンテンツ

- u32: バイト単位のバッファサイズ（ヘッダ値、終了タグ、パディングを含む）
- u32: バッファのリクエスト/レスポンスコード
    - リクエストコード
        - 0x00000000: 処理要求
        - その他の値は予約済
    - レスポンスコード
        - 0x80000000: リクエスト成功
        - 0x80000001: リクエストバッファの解析エラー（部分レスポンス）
        - その他の値は予約済
- u8...: 連結されたタグのシーケンス
- u32: 0x0（終了タグ）
- u8...: パディング

## タグのフォーマット

- u32: タグ識別子
- u32: バイト単位の値バッファサイズ
- u32:
    - リクエストコード
        - b31クリア: リクエスト
        - b30-b0: 予約済
    - レスポンスコード
        - b31セット: レスポンス
        - b30-b0: バイト単位の値長
- u8...: 値バッファ
- u8...: タグを32ビットにアラインするためのパディング

## タグ（ARMからVC）

### タグ一覧

| タグ       | 機能                                   |
| :--------- | :------------------------------------- |
| 0x00000001 | ファームウェアリビジョンの取得         |
| 0x00008010 | カーソル情報の設定                     |
| 0x00008011 | カーソル状態の設定                     |
| 0x00008012 | スクリーンガンマの設定（Pi3のみ）      |
| 0x00010001 | ボードモデルの取得                     |
| 0x00010002 | ボードリビジョンの取得                 |
| 0x00010003 | ボードMACアドレスの取得                |
| 0x00010004 | ボードシリアルの取得                   |
| 0x00010005 | ARMメモリの取得                        |
| 0x00010006 | VCメモリの取得                         |
| 0x00010007 | クロックの取得                         |
| 0x00020001 | 電源状態の取得                         |
| 0x00020002 | タイミングの取得                       |
| 0x00028001 | 電源状態の設定                         |
| 0x00030001 | クロック状態の取得                     |
| 0x00030002 | クロックレートの取得                   |
| 0x00030003 | 電圧の取得                             |
| 0x00030004 | 最大クロックレートの取得               |
| 0x00030005 | 最大電圧の取得                         |
| 0x00030006 | 温度の取得                             |
| 0x00030007 | 最小クロックレートの取得               |
| 0x00030008 | 最小電圧の取得                         |
| 0x00030009 | ターボの取得                           |
| 0x0003000a | 最大温度の取得                         |
| 0x0003000c | メモリの割り当て                       |
| 0x0003000d | メモリのロック                         |
| 0x0003000e | メモリのアンロック                     |
| 0x0003000f | メモリの解放                           |
| 0x00030010 | コードの実行                           |
| 0x00030014 | Dispmanxリソースのメモリハンドルの取得 |
| 0x00030020 | EDIDブロックの取得                     |
| 0x00030041 | オンボードLEDの状態の取得              |
| 0x00030047 | 測定したクロックレートの取得           |
| 0x00034041 | オンボードLEDのテスト                  |
| 0x00038001 | クロック状態の設定                     |
| 0x00038002 | クロックレートの設定                   |
| 0x00038003 | 電圧の設定                             |
| 0x00038009 | ターボの設定                           |
| 0x00038041 | オンボードLEDの状態の設定              |
| 0x00040001 | バッファの割り当て                     |
| 0x00040002 | スクリーンのクリア                     |
| 0x00040003 | 物理（ディスプレイ）幅/高さの取得      |
| 0x00040004 | 仮想（バッファ）幅/高さの取得          |
| 0x00040005 | 深度の取得                             |
| 0x00040006 | ピクセルオーダーの取得                 |
| 0x00040007 | アルファモードの取得                   |
| 0x00040008 | ピッチの取得                           |
| 0x00040009 | 仮想オフセットの取得                   |
| 0x0004000a | オーバースキャンの取得                 |
| 0x0004000b | パレットの取得                         |
| 0x00044003 | 物理（ディスプレイ）幅/高さのテスト    |
| 0x00044004 | 仮想（バッファ）幅/高さのテスト        |
| 0x00044005 | 深度のテスト                           |
| 0x00044006 | ピクセルオーダーのテスト               |
| 0x00044007 | アルファモードのテスト                 |
| 0x00044009 | 仮想オフセットのテスト                 |
| 0x0004400a | オーバースキャンのテスト               |
| 0x0004400b | パレットのテスト                       |
| 0x00048001 | バッファの解放                         |
| 0x00048003 | 物理（ディスプレイ）幅/高さの設定      |
| 0x00048004 | 仮想（バッファ）幅/高さの設定          |
| 0x00048005 | 深度の設定                             |
| 0x00048006 | ピクセルオーダーの設定                 |
| 0x00048007 | アルファモードの設定                   |
| 0x00048009 | 仮想オフセットの設定                   |
| 0x0004800a | オーバースキャンの設定                 |
| 0x0004800b | パレットの設定                         |
| 0x00050001 | コマンドラインの取得                   |
| 0x00060001 | DMAチャネルの取得                      |

### 0. ビデオコア: VideoCore (VC)

#### 0-1. ファームウェアリビジョンの取得: Get firmfare revision

- タグ: 0x00000001
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ファームウェアリビジョン

### 1. ハードウェア: Hardware

#### 1-1. ボードモデルの取得: Get board model

- タグ: 0x00010001
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ボードモデル

#### 1-2. ボードリビジョンの取得: Get board revision

- タグ: 0x00010002
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ボードリビジョン

#### 1-3. ボードMACアドレスの取得: Get board MAC address

- タグ: 0x00010003
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ネットワークバイトオーダーのMACアドレス

### 1-4. ボードシリアルの取得: Get board serial

- タグ: 0x00010004
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ボードシリアル

### 1-5. ARMメモリの取得: Get ARM memory

- タグ: 0x00010005
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: ベースアドレス（バイト）
    - u32: バイト単位のサイズ

将来のフォーマットでは複数のbase*sizeの組み合わせを指定できるようになる。

### 1-6. VCメモリの取得: Get VC memory

- タグ: 0x00010006
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: ベースアドレス（バイト）
    - u32: バイト単位のサイズ

将来のフォーマットでは複数のbase*sizeの組み合わせを指定できるようになる。

### 1-7. クロックの取得: Get clocks

- タグ: 0x00010007
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 可変（8の倍数）
  - 値
    - u32: 親クロックid（0はルートクロック）
    - u32: クロックid
    - （繰り返し）

すべてのクロックを**最上位から幅優先順で**返します。他のクロックに依存して
いるクロックはそのクロックの子として定義されるべきです。他のクロックに
依存していないクロックは親を持たないようにするべきです。クロックのIDは
以下のクロックセクションにある通りです。

(swarren: このクロックメッセージは以下に示す他のクロックメッセージと比べると
あまりよく定義されていません。有用なものにするには、呼び出し側が全ての
クロックが何であるかが分かるようにidとともにクロック名を返すか、以下で
示す他のクロックメッセージのように有効なクロックIDのリストをあらかじめ
定義しておく必要があるでしょう)

(lp0:クロックIDが以下のものと同じであることを明確にしました。これが0を
予約した理由です)

## 5. 構成: Config

### 5-1. コマンドラインの取得: Get command line

- タグ: 0x00050001
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 可変
  - 値
    - u8...: ASCIIコマンドライン文字列

Callerは文字列がNULL終端されていると仮定してはならない。

## 6. 共有資源管理: Shared resource management

### 6-1. DMAチャネルの取得: Get DMA channels

- タグ: 0x00060001
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 可変（8の倍数）
  - 値
    - u32: 親クロックid（0はルートクロック）

## 2. 電源: Power

一意なデバイスIDは次の通り。

- 0x00000000: SD Card
- 0x00000001: UART0
- 0x00000002: UART1
- 0x00000003: USB HCD
- 0x00000004: I2C0
- 0x00000005: I2C1
- 0x00000006: I2C2
- 0x00000007: SPI
- 0x00000008: CCP2TX
- 0x00000009: Unknown (RPi4)
- 0x0000000a: Unknown (RPi4)

### 2-1. 電源状態の取得: Get power state

- タグ: 0x00020001
- リクエスト:
  - 長さ: 4
  - 値:
    - u32: デバイスid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: デバイスid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=デバイス有り、1=デバイスなし
    - ビット2-31: 将来の利用のために予約済み

レスポインスは現在の状態を示します。

### 2-2. タイミングの取得: Get timing

- タグ: 0x00020002
- リクエスト:
  - 長さ: 4
    - u32: デバイスid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: デバイスid
    - u32: ミリ秒単位のenable waitタイム

レスポインスはデバイスの電源を入れてから電源が安定するまでに必要な
待ち時間を示します。

### 2-3. 電源状態の設定: Set power state

- タグ: 0x00028001
- リクエスト:
  - 長さ: 8
    - u32: デバイスid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=待たない、1=待つ
    - ビット2-31: 将来の利用のために予約済み（0にセット）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: デバイスid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=デバイス有り、1=デバイスなし
    - ビット2-31: 将来の利用のために予約済み

レスポンスは電源が安定するまで待つ/待たないに関わらず新しい状態を示します。

## 3. クロック

一意なクロックのIDは次のとおりです。

- 0x000000000: reserved
- 0x000000001: EMMC
- 0x000000002: UART
- 0x000000003: ARM
- 0x000000004: CORE
- 0x000000005: V3D
- 0x000000006: H264
- 0x000000007: ISP
- 0x000000008: SDRAM
- 0x000000009: PIXEL
- 0x00000000a: PWM
- 0x00000000b: HEVC
- 0x00000000c: EMMC2
- 0x00000000d: M2MC
- 0x00000000e: PIXEL_BVB

(swarren: もっと多くのクロックがあると思います。タグ`0x00010007`の
メッセージは親クロックの情報を返しましたが、ここにあげたクロックの
すべてがお互いの親になっているとは思えません。また、少なくとももう一つ、
ルートクリスタル/PLLを表すクロックIDが定義されているはずであり、この
クロックとここにあげたペリフェラルとの間に実際にはさまざまな中間
クロックが存在すると思われます。）

すべてのクロックはこれらのペリフェラルの**ベースクロック**です。
たとえば、UARTは3MHz、EMMCは50/100MHzです。ペリフェラルを使用する際の
分周器は適用されていません。

### 3-1. クロック状態の取得: Get clock state

- タグ: 0x00030001
- リクエスト:
  - 長さ: 4
    - u32: クロックid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=クロック有り、1=クロックなし
    - ビット2-31: 将来の利用のために予約済み

### 3-2. クロック状態の設定: Set clock state

- タグ: 0x00038001
- リクエスト:
  - 長さ: 8
    - u32: クロックid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=クロックあり、1=クロックなし
    - ビット2-31: 将来の利用のために予約済み（0にセット）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1: 0=クロックあり、1=クロックなし
    - ビット2-31: 将来の利用のために予約済み

(swallren:リクエストに「クロックあり」というビットがあるのは意味がない
と思います。意味のあるのはレスポンスだけです)

(lp0：レスポンスがないとタグ自体がサポートされていないのか否かが不明です）

### 3-3. クロックレートの取得: Get clock rate

- タグ: 0x00030002
- リクエスト:
  - 長さ: 4
    - u32: クロックid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: レート (Hz単位)

クロックが動作していなくても次に有効なレートが返るはずです。クロックが
ない場合はレート0が返ります。

### 3-4. オンボードLEDの状態の取得: Get onboard LED status

- タグ: 0x00030041
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: ピン番号
    - u32: 状態
  - ピン:
    - 42: 状態LED
    - 130: 電源LED

レスポンスはLEDピン番号とその状態(0または1)

### 3-5. オンボードLEDのテスト: Test onboard LED status

- タグ: 0x00034041
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: ピン番号
    - u32: 状態
  - ピン:
    - 42: 状態LED
    - 130: 電源LED

レスポンスはLEDピン番号とその状態(0または1)

### 3-6. オンボードLEDの状態の設定: Set onboard LED status

- タグ: 0x00038041
- リクエスト:
  - 長さ: 8
    - u32: ピン番号
    - u32: 状態
  - ピン:
    - 42: 状態LED
    - 130: 電源LED
- レスポンス;
  - 長さ: 8
  - 値
    - u32: ピン番号
    - u32: 状態
  - ピン:
    - 42: 状態LED
    - 130: 電源LED

レスポンスはLEDピン番号とその状態(0または1)

### 3-7. 測定したクロックレートの取得: Get clock rate measured

- タグ: 0x00030047
- リクエスト:
  - 長さ: 4
    - u32: クロックid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: レート (Hz単位)

（最新の「クロックレートの取得: 0x0003002」リクエストで返された値ではなく）
クランピング、スロットリング、クロック分割の制限を考慮した真の/実際の
クロックレートを取得します。

### 3-8. クロックレートの設定: Set clock rate

- タグ: 0x00038002
- リクエスト:
  - 長さ: 12
    - u32: クロックid
    - u32: レート (Hz単位)
    - u32: ターボ設定をスキップ
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: レート (Hz単位)

クロックが動作していなくても、次にサポートされるイネーブルレートが返される
はずです。クロックが存在しない場合は0が返されます。クロックレートはサポート
範囲にクランプされる場合があります。

デフォルトではデフォルト以上のARM周波数を設定すると他のターボ設定が有効に
なります（たとえば、電圧やsdram、GPU周波数）。「ターボ設定をスキップ」
に1をセットすることによりこの効果を無効にすることができます。

(swarren: "issue"で言及されているlp0の最小/最大レートと有効な親のリストに
ついては、投稿メッセージに有用な応答データがあります。また、親情報を取得
するためのメッセージがある場合、親のメッセージ設定機能も有用かもしれません)

### 3-9. 最大クロックレートの取得: Get max clock rate

- タグ: 0x00030004
- リクエスト:
  - 長さ: 4
    - u32: クロックid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: レート (Hz単位)

指定したクロックがサポートしている最大クロックレートを返します。
この値を超えるクロックを設定してはいけません。

### 3-10. 最小クロックレートの取得: Get min clock rate

- タグ: 0x00030007
- リクエスト:
  - 長さ: 4
    - u32: クロックid
- レスポンス;
  - 長さ: 8
  - 値
    - u32: クロックid
    - u32: レート (Hz単位)

指定したクロックがサポートしている最小クロックレートを返します。
アイドル時にはこの値を使用できるでしょう。

### 3-11. ターボの取得: Get turbo

- タグ: 0x00030009
- リクエスト:
  - 長さ: 4
    - u32: id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: id
    - u32: レベル

インデックスidのターボ状態を取得します。idは0でなければなりません。
ターボがない場合はレベル値は0、ある場合は1になります。

### 3-12. ターボの設定: Set turbo

- タグ: 0x00038009
- リクエスト:
  - 長さ: 8
    - u32: id
    - u32: レベル
- レスポンス;
  - 長さ: 8
  - 値
    - u32: id
    - u32: レベル

インデックスidのターボ状態を設定します。idは0でなければなりません。
ターボがない場合はレベル値は0、ある場合は1です。これによりGPUクロックは
有効時に最大、無効時に最小に設定されます。

## 3a. 電圧

一意な電圧IDは次のとおりです。

- 0x000000000: reserved
- 0x000000001: Core
- 0x000000002: SDRAM_C
- 0x000000003: SDRAM_P
- 0x000000004: SDRAM_I

### 3a-1. 電圧の取得: Get voltage

- タグ: 0x00030003
- リクエスト:
  - 長さ: 4
    - u32: 電圧id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 電圧id
    - u32: 値（マイクロボルト単位の絶対電圧）

電圧値はサポート範囲にクランプされる場合があります。値`0x80000000`は
idが不正であることを意味します。

### 3a-2. 電圧の設定: Set voltage

- タグ: 0x00028003
- リクエスト:
  - 長さ: 4
    - u32: 電圧id
    - u32: 値（次のように指定）
      - 値 <= 16: プラットフォーム固有の標準電圧に対する25mVステップの相対値。
      - 16 < 値 < 500000: マイクロボルト単位のプラットフォーム固有の標準電圧に対する相対値。
      - 値 >= 500000: マイクロボルト単位の絶対電圧値
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 電圧id
    - u32: 値（マイクロボルト単位の絶対電圧）

電圧値はサポート範囲にクランプされる場合があります。値`0x80000000`は
idが不正であることを意味します。

### 3a-3. 最大電圧の取得: Get max voltage

- タグ: 0x00030005
- リクエスト:
  - 長さ: 4
    - u32: 電圧id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 電圧id
    - u32: 値（マイクロボルト単位の絶対電圧）

指定したidがサポートしている最大電圧を返します。この値を超える電圧を
設定してはいけません。

### 3a-4. 最小電圧の取得: Get min voltage

- タグ: 0x00030008
- リクエスト:
  - 長さ: 4
    - u32: 電圧id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 電圧id
    - u32: 値（マイクロボルト単位の絶対電圧）

指定したidがサポートしている最小電圧を返します。アイドル時にはこの値を
使うことができるでしょう。

### 3a-5. 温度の取得: Get temperature

- タグ: 0x00030006
- リクエスト:
  - 長さ: 4
    - u32: 温度id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 温度id
    - u32: 値

SoCの温度を1/1000℃単位で返します。idは0でなければなりません。

### 3a-6. 最大温度の取得: Get max temperature

- タグ: 0x0003000a
- リクエスト:
  - 長さ: 4
    - u32: 温度id
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 温度id
    - u32: 値

SoCの最大安全温度を1/1000℃単位で返します。idは0でなければなりません。
オーバークロックはこの温度を超えると無効になる場合があります。

### 3a-6. メモリの割り当て: Allocate Memory

- タグ: 0x0003000c
- リクエスト:
  - 長さ: 12
    - u32: サイズ
    - u32: アライメント
    - u32: フラグ
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ハンドル

GPU上の連続メモリを割り当てます。サイズとアライメントはバイト単位です。
フラグは次のとおりです。

```
MEM_FLAG_DISCARDABLE = 1 << 0,      /* いつでも0にリサイズ可能。キャッシュデータに使用 */
MEM_FLAG_NORMAL = 0 << 2,           /* 標準割り当てのエイリアス。ARMからは使わないこと */
MEM_FLAG_DIRECT = 1 << 2,           /* 0xC アンキャッシュのエイリアス */
MEM_FLAG_COHERENT = 2 << 2,         /* 0x8 のエイリアス。L2には割り当てないがコヒーレント */
MEM_FLAG_L1_NONALLOCATING = (MEM_FLAG_DIRECT | MEM_FLAG_COHERENT),    /* L2に割り当て */
MEM_FLAG_ZERO = 1 << 4,             /* バッファをオールゼロに初期化 */
MEM_FLAG_NO_INIT = 1 << 5,          /* 初期化しない（デフォルトはオールゼロに初期化） */
MEM_FLAG_HINT_PERMALOCK = 1 << 6,   /* 長時間ロックされると思われる */
```

### 3a-7. メモリのロック: Lock Memory

- タグ: 0x0003000d
- リクエスト:
  - 長さ: 4
    - u32: ハンドル
- レスポンス;
  - 長さ: 4
  - 値
    - u32: バスアドレス

バッファをその場でロックし、バスアドレスを返します。メモリにアクセスする
前に行う必要があります。

### 3a-8. メモリのアンロック: Unlock Memory

- タグ: 0x0003000e
- リクエスト:
  - 長さ: 4
    - u32: ハンドル
- レスポンス;
  - 長さ: 4
  - 値
    - u32: status

バッファをアンロックします。コンテンツは残りますが、移動される場合が
あります。次に使用する前にロックする必要があります。status=0は成功です。

### 3a-9. メモリの解放: Release Memory

- タグ: 0x0003000f
- リクエスト:
  - 長さ: 4
    - u32: ハンドル
- レスポンス;
  - 長さ: 4
  - 値
    - u32: status

メモリバッファを開放します。status=0は成功です。

### 3a-10. コードの実行: Execute Code

- タグ: 0x00030010
- リクエスト:
  - 長さ: 28
    - u32: 関数ポインタ(fn)
    - u32: r0
    - u32: r1
    - u32: r2
    - u32: r3
    - u32: r4
    - u32: r5
- レスポンス;
  - 長さ: 4
  - 値
    - u32: r0

指定した（バス）アドレスの関数を指定した引数で呼び出します。たとえば、
`r0 = fn(r0, r1, r2, r3, r4, r5);` 呼び出しが完了するまでブロックされます。
(GPU)命令キャッシュは暗黙のうちにフラッシュされます。関数ポインタアドレスの
lsbを設定すると命令キャッシュのフラッシュが抑制されます。バッファが前回の
実行から変化していないことが分かっている場合に使用できるでしょう。

### 3a-11. Dispmanxリソースのメモリハンドルの取得: Get Dispmanx Resource mem handle

- タグ: 0x00030014
- リクエスト:
  - 長さ: 4
    - u32: dispmanx resource handle
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 成功の場合は0
    - u32: リソースのメモリハンドル

作成したdismanxリソースに付随するmem_handleを取得します。これをロックして
ARMから直接メモリを書き込むことで、画像データをGPUにコピーする手間を省く
ことができます。

### 3a-12. EDIDブロックの取得: Get EDID block

- タグ: 0x00030020
- リクエスト:
  - 長さ: 4
    - u32: ブロック番号
- レスポンス;
  - 長さ: 136
  - 値
    - u32: ブロック番号
    - u32: ステータス
    - 128バイト: EDIDブロック

接続されたHDMI/DVI機器から指定されたEDIDブロックを読み込みます。
128バイトのブロックは常に少なくとも1つ存在しますが、それ以上のブロックが
存在する場合もあります。0以外のステータスが返されるまで（0から始まる）
ブロックを要求し続けなければなりません。

## 4. フレームバッファ


- リクエストにあるすべてのタグは1回の操作で処理されます。
- TestタグとGet/Setタグを同じ操作で混在させることは無効であり、
  タグは返されません。
- GetタグはすべてのSetタグの後に処理されます。
- パラメータの設定時にバッファ割り当てタグが省略された場合、バッファの
  ベースやサイズを変更することなく対応できる場合を除き変更は発生しません。
- バッファ割り当てレスポンスが返されると、古いバッファ領域は（ベースまたは
  サイズが変更された場合）暗黙のうちに解放されます。

たとえば

- 現在値/デフォルト値は一時的な構造体にロードされます。
- タグを使用して値の一部または全部が上書きされます。
- Test/Setタグの検証が行なわれます。
- Setの変更が適用され、要求されたGet/Test/Setタグに基づくレスポンスが
  バッファに書き込まれます。

1つのリクエスト/レスポンスに同じタグを重複して使用することは禁止されて
います。想定される結果はエラーまたは実装で指定された未定義の動作（タグの
最後のインスタンスのみを使用するなど）のいずれかです。

### 4-1. バッファの割り当て: Allocate Memory

- タグ: 0x00040001
- リクエスト:
  - 長さ: 4
    - u32: アライメント(バイト単位)
- レスポンス;
  - 長さ: 8
  - 値
    - u32: フレームバッファのベースアドレス（バイト単位）
    - u32: フレームバッファのサイズ（バイト単位）

指定したアライメントがサポートされていない場合は、現在のベースとサイズ
（割り当てられていなければ両者は0）が返され、変更は生じません。

### 4-2. バッファの解放: Release Memory

- タグ: 0x00048001
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 0

フレームバッファを開放して無効にします。

### 4-3. スクリーンのクリア: Black Screen

- タグ: 0x00040002
- リクエスト:
  - 長さ: 4
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1-31: 将来の使用のために予約（0にセットする）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態
  - 状態:
    - ビット0: 0=オフ、1=オン
    - ビット1-31: 将来の使用のために予約（0にセットする）

### 4-4. 物理（ディスプレイ）幅/高さの取得: Get physical (display) with/height

- タグ: 0x00040003
- リクエスト:
  - 長さ: 4
    - u32: 状態
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

### 4-5. 物理（ディスプレイ）幅/高さのテスト: Test physical (display) with/height

- タグ: 0x00044003
- リクエスト:
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-6. 物理（ディスプレイ）幅/高さの設定: Set physical (display) with/height

- タグ: 0x00048003
- リクエスト:
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。
サポートされていない場合は以前の幅/高さか、0のいずれかです。

### 4-7. 仮想（バッファ）幅/高さの取得: Get virtual (buffer)) with/height

- タグ: 0x00040004
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

### 4-8. 仮想（バッファ）幅/高さのテスト: Test virtual (buffer)) with/height

- タグ: 0x00044004
- リクエスト:
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-9. 仮想（バッファ）幅/高さの設定: Set virtual (buffer)) with/height

- タグ: 0x00048004
- リクエスト:
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: 幅（ピクセル単位）
    - u32: 高さ（ピクセル単位）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。
サポートされていない場合は以前の幅/高さか、0のいずれかです。

### 4-10. 深度の取得: Get depth

- タグ: 0x00040005
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ピクセルあたりのビット数

### 4-11. 深度のテスト: Test depth

- タグ: 0x00044005
- リクエスト:
  - 長さ: 4
  - 値
    - u32: ピクセルあたりのビット数
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ピクセルあたりのビット数

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-12. 深度の設定: Set depth

- タグ: 0x00048005
- リクエスト:
  - 長さ: 4
  - 値
    - u32: ピクセルあたりのビット数
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ピクセルあたりのビット数

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。
サポートされていない場合は以前の深度か、0のいずれかです。

### 4-13. ピクセルオーダーの取得: Get pixel order

- タグ: 0x00040006
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態
  - 状態
    - 0x0: BGR
    - 0x1: RGB

### 4-14. ピクセルオーダーのテスト: Test pixel order

- タグ: 0x00044006
- リクエスト:
  - 長さ: 4
  - 値
    - u32: 状態（4-13を参照）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態（4-13を参照）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-15. ピクセルオーダーの設定: Set pixel order

- タグ: 0x00048006
- リクエスト:
  - 長さ: 4
  - 値
    - u32: 状態（4-13を参照）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態（4-13を参照）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。

### 4-16. アルファモードの取得: Get alpha mode

- タグ: 0x00040007
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態
  - 状態
    - 0x0: アルファチャンネルイネーブル（0 = 完全不透明）
    - 0x1: アルファチャンネル予約済（0 = 完全透明）
    - 0x2: アルファチャンネル無視

### 4-17. アルファモードのテスト: Test alpha mode

- タグ: 0x00044007
- リクエスト:
  - 長さ: 4
  - 値
    - u32: 状態（4-16を参照）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態（4-16を参照）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-18. アルファモードの設定: Set alpha mode

- タグ: 0x00048007
- リクエスト:
  - 長さ: 4
  - 値
    - u32: 状態（4-16を参照）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 状態（4-16を参照）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。

### 4-19. ピッチの取得: Get pitch

- タグ: 0x00040008
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 4
  - 値
    - u32: ラインあたりのバイト数

### 4-20. 仮想オフセットの取得: Get virtual offset

- タグ: 0x00040009
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 8
  - 値
    - u32: X（ピクセル単位）
    - u32: Y（ピクセル単位）

### 4-21. 仮想オフセットのテスト: Test virtual offset

- タグ: 0x00044009
- リクエスト:
  - 長さ: 8
  - 値
    - u32: X（ピクセル単位）
    - u32: Y（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: X（ピクセル単位）
    - u32: Y（ピクセル単位）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-22. 仮想オフセットの設定: Set virtual offset

- タグ: 0x00048009
- リクエスト:
  - 長さ: 8
  - 値
    - u32: X（ピクセル単位）
    - u32: Y（ピクセル単位）
- レスポンス;
  - 長さ: 8
  - 値
    - u32: X（ピクセル単位）
    - u32: Y（ピクセル単位）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。

### 4-23. オーバースキャンの取得: Get overscan

- タグ: 0x0004000a
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 16
  - 値
    - u32: 上（ピクセル単位）
    - u32: 下（ピクセル単位）
    - u32: 左（ピクセル単位）
    - u32: 右（ピクセル単位）

### 4-24. オーバースキャンのテスト: Test overscan

- タグ: 0x0004400a
- リクエスト:
  - 長さ: 16
  - 値
    - u32: 上（ピクセル単位）
    - u32: 下（ピクセル単位）
    - u32: 左（ピクセル単位）
    - u32: 右（ピクセル単位）
- レスポンス;
  - 長さ: 16
  - 値
    - u32: 上（ピクセル単位）
    - u32: 下（ピクセル単位）
    - u32: 左（ピクセル単位）
    - u32: 右（ピクセル単位）

レスポンスがリクエストと同じ（または変更されている）ことはこの構成が
（他のすべての設定との組み合わせで）サポートされているか否かを示します。
現在のハードウェアまたはフレームバッファの状態は変更しません。

### 4-25. オーバースキャンの設定: Set overscan

- タグ: 0x0004800a
- リクエスト:
  - 長さ: 16
  - 値
    - u32: 上（ピクセル単位）
    - u32: 下（ピクセル単位）
    - u32: 左（ピクセル単位）
    - u32: 右（ピクセル単位）
- レスポンス;
  - 長さ: 16
  - 値
    - u32: 上（ピクセル単位）
    - u32: 下（ピクセル単位）
    - u32: 左（ピクセル単位）
    - u32: 右（ピクセル単位）

レスポンスとリクエストは異なる場合があるのでチェックする必要があります。

### 4-26. パレットの取得: Get palette

- タグ: 0x0004000b
- リクエスト:
  - 長さ: 0
- レスポンス;
  - 長さ: 1024
  - 値
    - u32...: RGBAパレット値（インデック0-255）

### 4-27. パレットのテスト: Test palette

- タグ: 0x0004400b
- リクエスト:
  - 長さ: 24..1032
  - 値
    - u32: オフセット: セットする最初のパレットインデックス（0-255）
    - u32: 長さ: 設定するパレットエントリの数（1-256）
    - u32...: RGBAパレット値（オフセット - オフセット+長さ-1）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 0=妥当、1=不正

### 4-28. パレットの設定: Set palette

- タグ: 0x0004800b
- リクエスト:
  - 長さ: 24..1032
  - 値
    - u32: オフセット: セットする最初のパレットインデックス（0-255）
    - u32: 長さ: 設定するパレットエントリの数（1-256）
    - u32...: RGBAパレット値（オフセット - オフセット+長さ-1）
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 0=妥当、1=不正

### 4-29. カーソル情報の設定: Set Cursor Info

- タグ: 0x00008010
- リクエスト:
  - 長さ: 24
  - 値:
    - u32: 幅
    - u32: 長さ
    - u32: （未使用）
    - u32: ピクセルに対するポインタ
    - u32: ホットスポットX
    - u32: ホットスポットY
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 0=妥当、1=不正

フォーマットは32bpp (ARGB)です。幅と高さは>=16、(幅*高さ) <= 64 で
なければなりません。

### 4-30. カーソル状態の設定: Set Cursor State

- タグ: 0x00008011
- リクエスト:
  - 長さ: 16
  - 値:
    - u32: イネーブル（1=ビジブル、0=インビジブル）
    - u32: x
    - u32: y
    - u32: フラグ
- レスポンス;
  - 長さ: 4
  - 値
    - u32: 0=妥当、1=不正

フラグによる制御: bit0: 0=座標を表示, 1=フレームバッファ座標

「カーソル情報の設定」が呼び出されていない場合はデフォルトカーソルが
使用されます（64x64でホットスポットは0,0）。

(swarren: フレームバッファのget/test/setの各々を一つのメッセージで
行う方が良いということに同意します。そうすれば、testやsetが動作させる
ための完全な設定が常に利用できるからです。ただし、テストについては、
個々のテストメッセージが全体的な構成テストメッセージと並んで有用で
あるかもしれません。マルチヘッドについてはどうでしょうか。HDMIとTV
出力の両方を同時にアクティブにすることができるように。それともヘッダは
1つだけですか。HDMI YUVとRGB、HDMIオーディオ、~~HDMI EDID取り出し~~、
HDMI削減CEとPCのRGB空間などのオプションはサポートされていますか）

(lp0: 単一メッセージにより完全な構成が常に利用できるわけではありません。
呼び出し元が追加情報を欠いた古いバージョンを使用しているかもしれませんし、
これらの追加オプションを一つの大きな構造体に追加するより個別の値として
サポートしたほうが簡単な場合もあるでしょう)

### 4-31. スクリーンガンマの設定（Pi3のみ）: Set Screen Gamma

- タグ: 0x00008012
- リクエスト:
  - 長さ: 8
  - 値:
    - u32: ディスプレイ番号
    - u32: 768バイトのガンマ表のアドレス: 256バイトの赤、256バイトの緑、256バイトの青
- レスポンス;
  - 長さ: 40

このタグは[2010年1月9日に追加](https://github.com/raspberrypi/firmware/issues/971#issuecomment-452776264)されました。Pi4は異なるガンマ機構を使用
しているので、
[現在のところこのタグはPi4では動作しません](https://github.com/raspberrypi/firmware/issues/1274)。
開発者が小さな[例題プログラム](https://github.com/JamesH65/setgamma)を書いています。
